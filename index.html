<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸±à¸šà¸¢à¸­à¸” â€” à¸Ÿà¹‰à¸²à¸›à¸£à¸°à¸—à¸²à¸™</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --green:  #06C755; --green-dk: #00A040;
      --blue:   #0066CC; --blue-dk:  #0052A3;
      --bg:     #f0f4f8; --card: #fff;
      --text:   #1a1a2e; --muted: #6b7280;
      --border: #e5e7eb; --nav-h: 66px; --r: 14px;
      --shadow: 0 2px 12px rgba(0,0,0,.08);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Prompt',sans-serif;background:var(--bg);color:var(--text);
         min-height:100vh;max-width:480px;margin:0 auto}

    /* â”€â”€ Loading â”€â”€ */
    #loading{position:fixed;inset:0;background:linear-gradient(160deg,#06C755,#00A040);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:9999;color:#fff;transition:opacity .4s}
    #loading .logo{font-size:52px;margin-bottom:10px}
    #loading .ttl{font-size:20px;font-weight:600}
    #loading .sub{font-size:13px;opacity:.75;margin-top:4px}
    .spinner{width:34px;height:34px;margin-top:28px;border:3px solid rgba(255,255,255,.3);
      border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ Auth â”€â”€ */
    #auth{display:none;min-height:100vh;padding:32px 20px;
      align-items:center;justify-content:center;flex-direction:column}
    .auth-card{background:#fff;border-radius:20px;padding:32px 24px;width:100%;box-shadow:var(--shadow)}
    .auth-head{text-align:center;margin-bottom:24px}
    .auth-head .ico{font-size:54px}
    .auth-head h2{font-size:20px;font-weight:600;margin-top:8px}
    .auth-head p{font-size:13px;color:var(--muted);margin-top:4px}

    /* â”€â”€ App â”€â”€ */
    #app{display:none;min-height:100vh;padding-bottom:var(--nav-h)}
    .header{background:linear-gradient(135deg,#06C755,#00A040);color:#fff;
      padding:14px 20px 12px;position:sticky;top:0;z-index:200}
    .hdr-row{display:flex;align-items:center;justify-content:space-between}
    .hdr-logo{font-size:18px;font-weight:700}
    .hdr-admin{font-size:12px;opacity:.85;background:rgba(255,255,255,.2);
      padding:3px 10px;border-radius:20px}
    .hdr-date{font-size:12px;opacity:.7;margin-top:4px}

    /* â”€â”€ Pages â”€â”€ */
    .page{padding:14px 14px 20px;display:none;animation:fi .25s}
    .page.active{display:block}
    @keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* â”€â”€ Cards â”€â”€ */
    .card{background:var(--card);border-radius:var(--r);padding:18px 16px;
      margin-bottom:14px;box-shadow:var(--shadow)}
    .card-title{font-size:15px;font-weight:600;margin-bottom:14px;
      display:flex;align-items:center;gap:8px}
    .badge{font-size:11px;font-weight:500;padding:2px 8px;border-radius:20px;
      background:#e7f8ef;color:var(--green-dk)}
    .badge.blue{background:#e8f0fb;color:var(--blue-dk)}

    /* â”€â”€ Search bar â”€â”€ */
    .search-row{display:flex;gap:8px;align-items:flex-end;margin-bottom:16px}
    .search-row .fg{flex:1;margin:0}
    .btn-search{padding:11px 14px;background:var(--green);color:#fff;border:none;
      border-radius:10px;font-size:14px;font-weight:600;font-family:'Prompt',sans-serif;
      cursor:pointer;white-space:nowrap;transition:background .15s}
    .btn-search:active{background:var(--green-dk)}
    .btn-search.blue{background:var(--blue)}
    .btn-search.blue:active{background:var(--blue-dk)}

    /* â”€â”€ Form â”€â”€ */
    .fg{margin-bottom:14px}
    label.lbl{display:block;font-size:12px;font-weight:500;color:var(--muted);margin-bottom:5px}
    label.lbl .req{color:#ef4444;margin-left:2px}
    .ctrl{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;
      font-size:15px;font-family:'Prompt',sans-serif;color:var(--text);background:#fff;
      transition:border-color .2s;-webkit-appearance:none;appearance:none}
    .ctrl:focus{outline:none;border-color:var(--green)}
    select.ctrl{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right 10px center;
      background-size:22px;padding-right:34px}
    textarea.ctrl{resize:none}
    .amt-wrap{position:relative}
    .amt-pfx{position:absolute;left:13px;top:50%;transform:translateY(-50%);
      font-size:15px;color:var(--muted);pointer-events:none}
    .amt-wrap .ctrl{padding-left:28px}

    /* â”€â”€ Slip Upload â”€â”€ */
    .slip-section{border:2px dashed var(--border);border-radius:12px;
      padding:16px;text-align:center;cursor:pointer;transition:border-color .2s;
      margin-bottom:14px;position:relative}
    .slip-section:hover{border-color:var(--green)}
    .slip-section.has-img{border-style:solid;border-color:var(--green)}
    .slip-ico{font-size:32px;margin-bottom:6px}
    .slip-txt{font-size:13px;color:var(--muted)}
    .slip-section input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
    #slip-preview-d,#slip-preview-b{
      width:100%;max-height:240px;object-fit:contain;border-radius:8px;margin-bottom:8px;display:none}

    /* â”€â”€ Verify Badge â”€â”€ */
    .verify-box{border-radius:10px;padding:10px 12px;margin-bottom:14px;display:none;
      font-size:13px;font-weight:500;align-items:center;gap:8px}
    .verify-box.ok{background:#e7f8ef;color:#00703c;display:flex}
    .verify-box.delay{background:#fff8e1;color:#b45309;display:flex}
    .verify-box.fail{background:#fef2f2;color:#b91c1c;display:flex}
    .verify-box.skip{background:#f3f4f6;color:var(--muted);display:flex}
    .v-ico{font-size:20px}

    /* â”€â”€ Verify button â”€â”€ */
    .btn-verify{width:100%;padding:10px;background:#f3f4f6;color:var(--text);
      border:1.5px solid var(--border);border-radius:10px;font-size:14px;
      font-weight:600;font-family:'Prompt',sans-serif;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:6px;
      margin-bottom:12px;transition:all .15s}
    .btn-verify:hover{border-color:var(--green);color:var(--green)}
    .btn-verify:disabled{opacity:.5;cursor:not-allowed}

    /* â”€â”€ Submit â”€â”€ */
    .btn{width:100%;padding:13px;border:none;border-radius:11px;font-size:16px;
      font-weight:600;font-family:'Prompt',sans-serif;cursor:pointer;transition:all .15s;
      display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-primary{background:var(--green);color:#fff}
    .btn-primary:active{transform:scale(.97);background:var(--green-dk)}
    .btn-primary:disabled{background:#9de0be;cursor:not-allowed;transform:none}
    .btn-primary.blue{background:var(--blue)}
    .btn-primary.blue:active{background:var(--blue-dk)}
    .btn-primary.blue:disabled{background:#a3c4e8}

    /* â”€â”€ Bottom Nav â”€â”€ */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);
      width:100%;max-width:480px;height:var(--nav-h);background:#fff;
      border-top:1px solid var(--border);display:flex;z-index:300;
      box-shadow:0 -3px 12px rgba(0,0,0,.07)}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;
      justify-content:center;gap:3px;cursor:pointer;padding:6px 0;transition:background .15s}
    .nav-item:active{background:#f3f4f6}
    .nav-icon{font-size:27px;transition:transform .2s}
    .nav-label{font-size:11px;font-weight:500;color:var(--muted);transition:color .2s}
    .nav-item.active .nav-label{color:var(--green);font-weight:700}
    .nav-item.active .nav-icon{transform:scale(1.12)}
    .nav-item.active.blue-nav .nav-label{color:var(--blue)}
    .nav-divider{width:1px;background:var(--border);margin:10px 0;align-self:stretch}

    /* â”€â”€ Recent â”€â”€ */
    .recent-row{display:flex;justify-content:space-between;align-items:center;
      padding:10px 0;border-bottom:1px solid #f3f4f6}
    .recent-row:last-child{border:none}
    .rr-name{font-size:14px;font-weight:500}
    .rr-meta{font-size:11px;color:var(--muted);margin-top:2px}
    .rr-amt{font-size:15px;font-weight:700;color:var(--green);white-space:nowrap;margin-left:8px}
    .rr-amt.blue{color:var(--blue)}
    .empty{text-align:center;padding:24px 20px;color:var(--muted)}
    .empty .ico{font-size:36px;margin-bottom:8px}
    .empty p{font-size:13px}

    /* â”€â”€ Auth err / Toast â”€â”€ */
    .auth-err{color:#ef4444;font-size:13px;margin-bottom:12px;display:none}
    .pin-ctrl{text-align:center;letter-spacing:10px;font-size:22px;font-weight:600}
    .toast{position:fixed;bottom:calc(var(--nav-h) + 14px);left:50%;
      transform:translateX(-50%) translateY(16px);background:#1a1a2e;color:#fff;
      padding:11px 22px;border-radius:30px;font-size:14px;opacity:0;
      transition:all .3s;z-index:9999;pointer-events:none;white-space:nowrap;
      box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.ok{background:var(--green)}
    .toast.err{background:#ef4444}

    /* â”€â”€ Results count â”€â”€ */
    .result-count{font-size:12px;color:var(--muted);margin:-6px 0 10px;padding-left:2px}
  </style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="logo">ğŸ’°</div>
  <div class="ttl">à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸±à¸šà¸¢à¸­à¸”</div>
  <div class="sub">à¸Ÿà¹‰à¸²à¸›à¸£à¸°à¸—à¸²à¸™ à¸ˆà¸³à¸à¸±à¸”</div>
  <div class="spinner"></div>
</div>

<!-- Auth -->
<div id="auth">
  <div class="auth-card">
    <div class="auth-head">
      <div class="ico">ğŸ”</div>
      <h2>à¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™</h2>
      <p>à¸à¸£à¸­à¸ PIN à¹€à¸à¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡ LINE à¸à¸±à¸šà¸šà¸±à¸à¸Šà¸µà¹à¸­à¸”à¸¡à¸´à¸™</p>
    </div>
    <div class="fg">
      <label class="lbl">LINE Display Name</label>
      <input type="text" class="ctrl" id="auth-name" readonly />
    </div>
    <div class="fg">
      <label class="lbl">PIN <span class="req">*</span></label>
      <input type="password" class="ctrl pin-ctrl" id="auth-pin"
             placeholder="â€¢ â€¢ â€¢ â€¢ â€¢ â€¢" maxlength="10" inputmode="numeric" />
    </div>
    <div class="auth-err" id="auth-err"></div>
    <button class="btn btn-primary" id="auth-btn" onclick="doVerifyPin()">
      <span>ğŸ”“</span> à¹€à¸‚à¹‰à¸²à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
    </button>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="header">
    <div class="hdr-row">
      <div class="hdr-logo">ğŸ’° à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸±à¸šà¸¢à¸­à¸”</div>
      <div class="hdr-admin" id="hdr-admin">â€”</div>
    </div>
    <div class="hdr-date" id="hdr-date"></div>
  </div>

  <!-- â•â•â•â• PAGE: à¸¡à¸±à¸”à¸ˆà¸³ â•â•â•â• -->
  <div class="page active" id="page-deposit">
    <div class="card">
      <div class="card-title">ğŸ“¥ à¸£à¸±à¸šà¸¢à¸­à¸”à¸¡à¸±à¸”à¸ˆà¸³ <span class="badge">Deposit</span></div>

      <!-- à¸„à¹‰à¸™à¸«à¸²à¸ˆà¸²à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸‡à¸²à¸™ -->
      <div class="search-row">
        <div class="fg">
          <label class="lbl">ğŸ—“ à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸‡à¸²à¸™ (à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²)</label>
          <input type="date" class="ctrl" id="d-event-date" />
        </div>
        <button class="btn-search" onclick="searchQuotes('deposit')">à¸„à¹‰à¸™à¸«à¸²</button>
      </div>
      <div class="result-count" id="d-result-count"></div>

      <div class="fg">
        <label class="lbl">à¸¥à¸¹à¸à¸„à¹‰à¸² / Quote <span class="req">*</span></label>
        <select class="ctrl" id="d-quote">
          <option value="">â€” à¸à¸”à¸„à¹‰à¸™à¸«à¸²à¸«à¸£à¸·à¸­à¹€à¸¥à¸·à¸­à¸ Quote â€”</option>
        </select>
      </div>
      <div class="fg">
        <label class="lbl">à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²</label>
        <input type="text" class="ctrl" id="d-customer" placeholder="à¸”à¸¶à¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ / à¸à¸£à¸­à¸à¹€à¸­à¸‡" />
      </div>

      <!-- Slip Upload -->
      <label class="lbl">ğŸ“ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›</label>
      <div class="slip-section" id="slip-zone-d">
        <img id="slip-preview-d" alt="slip" />
        <div id="slip-placeholder-d">
          <div class="slip-ico">ğŸ§¾</div>
          <div class="slip-txt">à¹à¸•à¸°à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ªà¸¥à¸´à¸› / à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›</div>
        </div>
        <input type="file" accept="image/*" id="slip-file-d" onchange="onSlipSelected('d')" />
      </div>
      <button class="btn-verify" id="d-verify-btn" onclick="doVerifySlip('d')" disabled>
        <span>ğŸ”„</span> à¸•à¸£à¸§à¸ˆà¸ªà¸¥à¸´à¸›à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
      </button>
      <div class="verify-box" id="d-verify-box">
        <span class="v-ico" id="d-v-ico">â€”</span>
        <span id="d-v-msg">â€”</span>
      </div>

      <div class="fg">
        <label class="lbl">à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸¡à¸±à¸”à¸ˆà¸³ (à¸šà¸²à¸—) <span class="req">*</span></label>
        <div class="amt-wrap">
          <span class="amt-pfx">à¸¿</span>
          <input type="number" class="ctrl" id="d-amount"
                 placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="fg">
        <label class="lbl">à¸§à¸±à¸™à¸—à¸µà¹ˆà¸£à¸±à¸šà¹€à¸‡à¸´à¸™ <span class="req">*</span></label>
        <input type="date" class="ctrl" id="d-date" />
      </div>
      <div class="fg">
        <label class="lbl">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label>
        <textarea class="ctrl" id="d-note" rows="2" placeholder="à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡â€¦"></textarea>
      </div>
      <button class="btn btn-primary" id="d-btn" onclick="doSubmitDeposit()">
        <span>âœ…</span> à¸šà¸±à¸™à¸—à¸¶à¸ + à¸ªà¹ˆà¸‡ LINE
      </button>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“‹ à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (à¸¡à¸±à¸”à¸ˆà¸³)</div>
      <div id="recent-deposit"><div class="empty"><div class="ico">ğŸ“­</div><p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</p></div></div>
    </div>
  </div>

  <!-- â•â•â•â• PAGE: à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­ â•â•â•â• -->
  <div class="page" id="page-balance">
    <div class="card">
      <div class="card-title">ğŸ’¸ à¸£à¸±à¸šà¸¢à¸­à¸”à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­ <span class="badge blue">Balance</span></div>

      <!-- à¸„à¹‰à¸™à¸«à¸²à¸ˆà¸²à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸‡à¸²à¸™ -->
      <div class="search-row">
        <div class="fg">
          <label class="lbl">ğŸ—“ à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸‡à¸²à¸™ (à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²)</label>
          <input type="date" class="ctrl" id="b-event-date" />
        </div>
        <button class="btn-search blue" onclick="searchQuotes('balance')">à¸„à¹‰à¸™à¸«à¸²</button>
      </div>
      <div class="result-count" id="b-result-count"></div>

      <div class="fg">
        <label class="lbl">à¸¥à¸¹à¸à¸„à¹‰à¸² / Quote <span class="req">*</span></label>
        <select class="ctrl" id="b-quote">
          <option value="">â€” à¸à¸”à¸„à¹‰à¸™à¸«à¸²à¸«à¸£à¸·à¸­à¹€à¸¥à¸·à¸­à¸ Quote â€”</option>
        </select>
      </div>
      <div class="fg">
        <label class="lbl">à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²</label>
        <input type="text" class="ctrl" id="b-customer" placeholder="à¸”à¸¶à¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ / à¸à¸£à¸­à¸à¹€à¸­à¸‡" />
      </div>

      <!-- Slip Upload -->
      <label class="lbl">ğŸ“ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›</label>
      <div class="slip-section" id="slip-zone-b">
        <img id="slip-preview-b" alt="slip" />
        <div id="slip-placeholder-b">
          <div class="slip-ico">ğŸ§¾</div>
          <div class="slip-txt">à¹à¸•à¸°à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ªà¸¥à¸´à¸› / à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›</div>
        </div>
        <input type="file" accept="image/*" id="slip-file-b" onchange="onSlipSelected('b')" />
      </div>
      <button class="btn-verify" id="b-verify-btn" onclick="doVerifySlip('b')" disabled>
        <span>ğŸ”„</span> à¸•à¸£à¸§à¸ˆà¸ªà¸¥à¸´à¸›à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
      </button>
      <div class="verify-box" id="b-verify-box">
        <span class="v-ico" id="b-v-ico">â€”</span>
        <span id="b-v-msg">â€”</span>
      </div>

      <div class="fg">
        <label class="lbl">à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ (à¸šà¸²à¸—) <span class="req">*</span></label>
        <div class="amt-wrap">
          <span class="amt-pfx">à¸¿</span>
          <input type="number" class="ctrl" id="b-amount"
                 placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="fg">
        <label class="lbl">à¸§à¸±à¸™à¸—à¸µà¹ˆà¸£à¸±à¸šà¹€à¸‡à¸´à¸™ <span class="req">*</span></label>
        <input type="date" class="ctrl" id="b-date" />
      </div>
      <div class="fg">
        <label class="lbl">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label>
        <textarea class="ctrl" id="b-note" rows="2" placeholder="à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡â€¦"></textarea>
      </div>
      <button class="btn btn-primary blue" id="b-btn" onclick="doSubmitBalance()">
        <span>âœ…</span> à¸šà¸±à¸™à¸—à¸¶à¸ + à¸ªà¹ˆà¸‡ LINE
      </button>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“‹ à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­)</div>
      <div id="recent-balance"><div class="empty"><div class="ico">ğŸ“­</div><p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</p></div></div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-item active" id="nav-deposit" onclick="switchPage('deposit')">
      <div class="nav-icon">ğŸ“¥</div>
      <div class="nav-label">à¸£à¸±à¸šà¸¡à¸±à¸”à¸ˆà¸³</div>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-item blue-nav" id="nav-balance" onclick="switchPage('balance')">
      <div class="nav-icon">ğŸ’¸</div>
      <div class="nav-label">à¸£à¸±à¸šà¸„à¸‡à¹€à¸«à¸¥à¸·à¸­</div>
    </div>
  </nav>
</div>

<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LIFF_ID = '2009224163-ZyLVfnoq';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbw6PZFfd0hjS1P8AvDZigtcFcGlpkr6Kvip0eCJQtJl4kOIFRc8L-EcuNPU95wa23acjg/exec';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let lineUserId  = '';
let adminName   = '';
let slipData    = { d: null, b: null };   // slip verify result per tab
let slipFile    = { d: null, b: null };   // base64 file data per tab

/* â”€â”€â”€ Init â”€â”€â”€ */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }

    const profile = await liff.getProfile();
    lineUserId = profile.userId;
    document.getElementById('auth-name').value = profile.displayName;
    setTodayDates();
    setHeaderDate();

    const res = await api({ action: 'checkAdmin', lineUserId });
    if (res.status === 'approved') {
      adminName = res.name;
      await afterAuth();
    } else {
      hideLoading();
      showEl('auth', 'flex');
    }
  } catch (err) {
    console.error(err);
    if (['localhost','127.0.0.1'].includes(location.hostname)) {
      setTodayDates(); setHeaderDate(); hideLoading(); showEl('app','block');
    } else {
      toast('âš ï¸ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸” à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ','err'); hideLoading();
    }
  }
}

async function afterAuth() {
  document.getElementById('hdr-admin').textContent = 'ğŸ‘¤ ' + adminName;
  await loadRecent();
  hideLoading();
  showEl('auth','none');
  showEl('app','block');
}

/* â”€â”€â”€ Auth PIN â”€â”€â”€ */
async function doVerifyPin() {
  const pin = document.getElementById('auth-pin').value.trim();
  if (!pin) { showAuthErr('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ PIN'); return; }
  setBtnLoad('auth-btn', true);
  try {
    const res = await api({ action: 'registerAdmin', lineUserId, pin });
    if (res.status === 'approved') { adminName = res.name; await afterAuth(); }
    else if (res.status === 'already_linked') showAuthErr('LINE à¸™à¸µà¹‰à¸–à¸¹à¸à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§');
    else showAuthErr('PIN à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸«à¸£à¸·à¸­à¸–à¸¹à¸à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸›à¹à¸¥à¹‰à¸§');
  } catch(e) { showAuthErr('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸” à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ'); }
  setBtnLoad('auth-btn', false, 'ğŸ”“ à¹€à¸‚à¹‰à¸²à¹ƒà¸Šà¹‰à¸‡à¸²à¸™');
}

/* â”€â”€â”€ Search Quotes by Event Date â”€â”€â”€ */
async function searchQuotes(tab) {
  const p    = tab === 'deposit' ? 'd' : 'b';
  const date = document.getElementById(p + '-event-date').value;
  const sel  = document.getElementById(p + '-quote');
  const cnt  = document.getElementById(p + '-result-count');

  if (!date) { toast('âš ï¸ à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸‡à¸²à¸™à¸à¹ˆà¸­à¸™','err'); return; }

  cnt.textContent = 'â³ à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²â€¦';
  sel.innerHTML = '<option value="">â³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”â€¦</option>';

  try {
    const url = `${GAS_URL}?action=getQuotesByDate&date=${date}`;
    const res = await (await fetch(url)).json();
    const quotes = res.quotes || [];

    sel.innerHTML = '<option value="">â€” à¹€à¸¥à¸·à¸­à¸ Quote â€”</option>';
    quotes.forEach(q => sel.add(new Option(q.label, q.quoteNo, false, false)));

    cnt.textContent = quotes.length
      ? `à¸à¸š ${quotes.length} à¸£à¸²à¸¢à¸à¸²à¸£ (à¸—à¸¸à¸à¹à¸­à¸”à¸¡à¸´à¸™)`
      : 'â€” à¹„à¸¡à¹ˆà¸à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¹ƒà¸™à¸§à¸±à¸™à¸—à¸µà¹ˆà¸™à¸µà¹‰ â€”';

    // à¸–à¹‰à¸²à¸¡à¸µà¹à¸„à¹ˆ 1 à¸£à¸²à¸¢à¸à¸²à¸£ â†’ à¹€à¸¥à¸·à¸­à¸à¹ƒà¸«à¹‰à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
    if (quotes.length === 1) {
      sel.value = quotes[0].quoteNo;
      document.getElementById(p + '-customer').value = quotes[0].customer;
    }
  } catch(e) { cnt.textContent = ''; toast('âŒ à¸„à¹‰à¸™à¸«à¸²à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ','err'); }
}

/* â”€â”€â”€ Quote change â†’ auto-fill customer â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  ['d','b'].forEach(p => {
    document.getElementById(p + '-quote').addEventListener('change', function() {
      const opt = this.options[this.selectedIndex];
      if (opt && opt.text && opt.text.includes(' â€” ')) {
        const cus = opt.text.split(' â€” ').slice(1).join(' â€” ');
        document.getElementById(p + '-customer').value = cus;
      }
    });
  });
});

/* â”€â”€â”€ à¸•à¸£à¸§à¸ˆà¸«à¸² QR Code à¸ˆà¸²à¸à¸£à¸¹à¸›à¸”à¹‰à¸§à¸¢ jsQR â”€â”€â”€ */
function detectQRCode(dataUrl) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = function() {
      try {
        const canvas  = document.createElement('canvas');
        canvas.width  = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        resolve(code ? code.data : null);   // à¸„à¸·à¸™ QR string à¸–à¹‰à¸²à¹€à¸ˆà¸­, null à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­
      } catch(e) { resolve(null); }
    };
    img.onerror = () => resolve(null);
    img.src = dataUrl;
  });
}

/* â”€â”€â”€ Slip Selected â†’ à¸•à¸£à¸§à¸ˆ QR à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢à¸ªà¹ˆà¸‡ SlipOK â”€â”€â”€ */
function onSlipSelected(p) {
  const file = document.getElementById('slip-file-' + p).files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = e.target.result.split(',')[1];
    slipFile[p] = { data: base64, mimeType: file.type, name: file.name };

    // Preview
    const preview = document.getElementById('slip-preview-' + p);
    preview.src = e.target.result;
    preview.style.display = 'block';
    document.getElementById('slip-placeholder-' + p).style.display = 'none';
    document.getElementById('slip-zone-' + p).classList.add('has-img');

    slipData[p] = null;
    document.getElementById(p + '-verify-btn').disabled = true;
    showVerifyBox(p, 'skip', 'ğŸ”', 'à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸«à¸² QR codeâ€¦');

    // â”€â”€ Step 1: à¸•à¸£à¸§à¸ˆà¸«à¸² QR code à¸à¸±à¹ˆà¸‡ browser â”€â”€
    const qrData = await detectQRCode(e.target.result);

    if (qrData) {
      // à¸¡à¸µ QR â†’ à¸ªà¹ˆà¸‡ SlipOK à¸•à¸£à¸§à¸ˆà¸•à¹ˆà¸­à¸—à¸±à¸™à¸—à¸µ
      showVerifyBox(p, 'skip', 'â³', 'à¸à¸š QR code â€” à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸•à¸£à¸§à¸ˆ SlipOKâ€¦');
      doVerifySlip(p);
    } else {
      // à¹„à¸¡à¹ˆà¸¡à¸µ QR â†’ à¹à¸ˆà¹‰à¸‡à¹ƒà¸«à¹‰à¸à¸£à¸­à¸à¹€à¸­à¸‡
      showVerifyBox(p, 'skip', 'ğŸ“', 'à¹„à¸¡à¹ˆà¸à¸š QR code â€” à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸¢à¸­à¸”à¹à¸¥à¸°à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸­à¸‡');
      document.getElementById(p + '-verify-btn').disabled = false;  // à¹€à¸›à¸´à¸”à¸›à¸¸à¹ˆà¸¡à¸•à¸£à¸§à¸ˆà¹ƒà¸«à¸¡à¹ˆà¹„à¸§à¹‰à¹€à¸œà¸·à¹ˆà¸­
    }
  };
  reader.readAsDataURL(file);
}

/* â”€â”€â”€ Verify Slip â”€â”€â”€ */
async function doVerifySlip(p) {
  if (!slipFile[p]) { toast('âš ï¸ à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ªà¸¥à¸´à¸›à¸à¹ˆà¸­à¸™','err'); return; }

  const btn = document.getElementById(p + '-verify-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0 auto"></div>';

  try {
    const res = await api({ action: 'verifySlip', file: slipFile[p] });

    if (res.status !== 'ok' || !res.result) {
      toast('âŒ à¸•à¸£à¸§à¸ˆà¸ªà¸¥à¸´à¸›à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + (res.message || ''), 'err');
      showVerifyBox(p, 'fail', 'âŒ', 'à¸•à¸£à¸§à¸ˆà¸ªà¸¥à¸´à¸›à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
    } else {
      const r = res.result;
      slipData[p] = r;

      if (r.verified) {
        showVerifyBox(p, 'ok', 'âœ…', `VERIFIED â€” à¸¿${fmt(r.depositAmount)} (${r.sendingBank || '?'} â†’ à¸£à¸±à¸š)`);
        // Auto-fill amount & date
        if (r.depositAmount > 0)  document.getElementById(p + '-amount').value = r.depositAmount;
        if (r.depositDate)         document.getElementById(p + '-date').value   = r.depositDate;
        toast('âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸¥à¸´à¸›à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', 'ok');

      } else if (r.verifyStatus === 'DELAY') {
        showVerifyBox(p, 'delay', 'â³', `DELAY (à¸£à¸­ ${r.delayMin || '?'} à¸™à¸²à¸—à¸µ) â€” ` + r.verifyMessage);
        if (r.depositAmount > 0) document.getElementById(p + '-amount').value = r.depositAmount;
        if (r.depositDate)        document.getElementById(p + '-date').value   = r.depositDate;
        toast('â³ à¸ªà¸¥à¸´à¸›à¸­à¸¢à¸¹à¹ˆà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š (DELAY)', '');

      } else {
        showVerifyBox(p, 'fail', 'âŒ', `FAILED [${r.verifyCode}] â€” ` + r.verifyMessage);
        toast('âš ï¸ à¸ªà¸¥à¸´à¸›à¸•à¸£à¸§à¸ˆà¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™: ' + r.verifyMessage, 'err');
      }
    }
  } catch(e) { toast('âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' + e.message, 'err'); }

  btn.disabled = false;
  btn.innerHTML = '<span>ğŸ”„</span> à¸•à¸£à¸§à¸ˆà¸ªà¸¥à¸´à¸›à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡';
}

function showVerifyBox(p, type, ico, msg) {
  const box  = document.getElementById(p + '-verify-box');
  const icoEl = document.getElementById(p + '-v-ico');
  const msgEl = document.getElementById(p + '-v-msg');
  box.className = 'verify-box ' + type;
  icoEl.textContent = ico;
  msgEl.textContent = msg;
}

/* â”€â”€â”€ Submit Deposit â”€â”€â”€ */
async function doSubmitDeposit() {
  const quoteNo  = v('d-quote');
  const customer = v('d-customer');
  const amount   = v('d-amount');
  const date     = v('d-date');
  const note     = v('d-note');

  if (!quoteNo || !amount || !date) { toast('âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š','err'); return; }
  if (+amount <= 0) { toast('âš ï¸ à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 0','err'); return; }

  setBtnLoad('d-btn', true);
  try {
    const slip = buildSlipPayload('d');
    const res  = await api({ action:'saveDeposit', lineUserId, adminName,
                              quoteNo, customer, amount:+amount, date, note, slip });
    if (res.status === 'success') {
      toast('âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸¡à¸±à¸”à¸ˆà¸³ + à¹à¸ˆà¹‰à¸‡ LINE à¹à¸¥à¹‰à¸§', 'ok');
      resetForm('d');
      await loadRecent();
    } else { toast('âŒ ' + (res.message || 'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ'), 'err'); }
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
  setBtnLoad('d-btn', false, 'âœ… à¸šà¸±à¸™à¸—à¸¶à¸ + à¸ªà¹ˆà¸‡ LINE');
}

/* â”€â”€â”€ Submit Balance â”€â”€â”€ */
async function doSubmitBalance() {
  const quoteNo  = v('b-quote');
  const customer = v('b-customer');
  const amount   = v('b-amount');
  const date     = v('b-date');
  const note     = v('b-note');

  if (!quoteNo || !amount || !date) { toast('âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š','err'); return; }
  if (+amount <= 0) { toast('âš ï¸ à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 0','err'); return; }

  setBtnLoad('b-btn', true);
  try {
    const slip = buildSlipPayload('b');
    const res  = await api({ action:'saveBalance', lineUserId, adminName,
                              quoteNo, customer, amount:+amount, date, note, slip });
    if (res.status === 'success') {
      toast('âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­ + à¹à¸ˆà¹‰à¸‡ LINE à¹à¸¥à¹‰à¸§', 'ok');
      resetForm('b');
      await loadRecent();
    } else { toast('âŒ ' + (res.message || 'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ'), 'err'); }
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
  setBtnLoad('b-btn', false, 'âœ… à¸šà¸±à¸™à¸—à¸¶à¸ + à¸ªà¹ˆà¸‡ LINE');
}

function buildSlipPayload(p) {
  const r = slipData[p];
  if (!r) return { verifyStatus: 'SKIPPED' };
  const d = r.slipData || {};
  return {
    verifyStatus:         r.verifyStatus,
    verifyCode:           r.verifyCode,
    verifyMessage:        r.verifyMessage,
    transTimestamp:       d.transTimestamp    || '',
    transRef:             d.transRef          || '',
    transDate:            d.transDate         || '',
    transTime:            d.transTime         || '',
    sendingBank:          d.sendingBank        || '',
    receivingBank:        d.receivingBank      || '',
    transFeeAmount:       d.transFeeAmount     || 0,
    senderDisplayName:    (d.sender && d.sender.displayName) || '',
    senderName:           (d.sender && d.sender.name)        || '',
    senderAccountValue:   (d.sender && d.sender.account && d.sender.account.value) || '',
    receiverDisplayName:  (d.receiver && d.receiver.displayName) || '',
    receiverName:         (d.receiver && d.receiver.name)        || '',
    receiverAccountValue: (d.receiver && d.receiver.account && d.receiver.account.value) || '',
    qrcodeData:           r.qrcodeData || ''
  };
}

/* â”€â”€â”€ Load Recent â”€â”€â”€ */
async function loadRecent() {
  try {
    const res = await api({ action:'getRecent', limit:5 });
    renderRecent('recent-deposit', res.deposits||[], false);
    renderRecent('recent-balance', res.balances||[], true);
  } catch(e) {}
}

function renderRecent(id, items, isBlue) {
  const el = document.getElementById(id);
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="ico">ğŸ“­</div><p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</p></div>';
    return;
  }
  el.innerHTML = items.map(r => `
    <div class="recent-row">
      <div>
        <div class="rr-name">${r.quoteNo} â€” ${r.customer||'â€”'}</div>
        <div class="rr-meta">${r.date} Â· ${r.by||'â€”'}</div>
      </div>
      <div class="rr-amt${isBlue?' blue':''}">à¸¿${fmt(r.amount)}</div>
    </div>`).join('');
}

/* â”€â”€â”€ Navigation â”€â”€â”€ */
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('nav-'+page).classList.add('active');
  window.scrollTo(0,0);
}

/* â”€â”€â”€ API â”€â”€â”€ */
async function api(payload) {
  const res = await fetch(GAS_URL, {
    method:'POST', headers:{'Content-Type':'text/plain'},
    body: JSON.stringify(payload)
  });
  return res.json();
}

/* â”€â”€â”€ Helpers â”€â”€â”€ */
function v(id) { return document.getElementById(id).value.trim(); }

function setTodayDates() {
  const t = new Date().toISOString().split('T')[0];
  ['d-date','b-date'].forEach(id => { const el=document.getElementById(id); if(el) el.value=t; });
}
function setHeaderDate() {
  const el = document.getElementById('hdr-date');
  if (el) el.textContent = new Date().toLocaleDateString('th-TH',
    { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}
function hideLoading() {
  const el = document.getElementById('loading');
  el.style.opacity = '0';
  setTimeout(() => el.style.display='none', 420);
}
function showEl(id, display) { document.getElementById(id).style.display = display; }
function showAuthErr(msg) {
  const el = document.getElementById('auth-err');
  el.textContent = msg; el.style.display = 'block';
}
function resetForm(p) {
  ['quote','customer','amount','note'].forEach(f => {
    const el = document.getElementById(p+'-'+f);
    if (!el) return;
    el.tagName==='SELECT' ? (el.selectedIndex=0) : (el.value='');
  });
  setTodayDates();
  // reset slip
  slipData[p] = null; slipFile[p] = null;
  document.getElementById('slip-preview-'+p).style.display = 'none';
  document.getElementById('slip-placeholder-'+p).style.display = 'block';
  document.getElementById('slip-zone-'+p).classList.remove('has-img');
  document.getElementById('slip-file-'+p).value = '';
  document.getElementById(p+'-verify-btn').disabled = true;
  document.getElementById(p+'-verify-box').className = 'verify-box';
  document.getElementById(p+'-result-count').textContent = '';
}
function setBtnLoad(id, loading, label) {
  const btn = document.getElementById(id);
  btn.disabled = loading;
  if (loading) btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div>';
  else if (label) btn.innerHTML = label;
}
function fmt(n) { return Number(n||0).toLocaleString('th-TH',{minimumFractionDigits:2}); }
let _tt;
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast '+(type||'');
  void el.offsetWidth; el.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(()=>el.classList.remove('show'), 3200);
}

init();
</script>
</body>
</html>
