<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î ‚Äî ‡∏ü‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --green:  #0ea5e9; --green-dk: #0284c7;
      --blue:   #0369a1; --blue-dk:  #075985;
      --bg:     #f0f6fb; --card: #fff;
      --text:   #0f172a; --muted: #6b7280;
      --border: #e2e8f0; --nav-h: 66px; --r: 14px;
      --shadow: 0 2px 12px rgba(14,165,233,.10);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Prompt',sans-serif;background:var(--bg);color:var(--text);
         min-height:100vh;max-width:480px;margin:0 auto}

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    #loading{position:fixed;inset:0;background:linear-gradient(160deg,#0ea5e9,#0284c7);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:9999;color:#fff;transition:opacity .4s}
    #loading .logo{font-size:52px;margin-bottom:10px}
    #loading .ttl{font-size:20px;font-weight:600}
    #loading .sub{font-size:13px;opacity:.75;margin-top:4px}
    .spinner{width:34px;height:34px;margin-top:28px;border:3px solid rgba(255,255,255,.3);
      border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
    #auth{display:none;min-height:100vh;padding:32px 20px;
      align-items:center;justify-content:center;flex-direction:column}
    .auth-card{background:#fff;border-radius:20px;padding:32px 24px;width:100%;box-shadow:var(--shadow)}
    .auth-head{text-align:center;margin-bottom:24px}
    .auth-head .ico{font-size:54px}
    .auth-head h2{font-size:20px;font-weight:600;margin-top:8px}
    .auth-head p{font-size:13px;color:var(--muted);margin-top:4px}

    /* ‚îÄ‚îÄ App ‚îÄ‚îÄ */
    #app{display:none;min-height:100vh;padding-bottom:var(--nav-h)}
    .header{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;
      padding:14px 20px 12px;position:sticky;top:0;z-index:200}
    .hdr-row{display:flex;align-items:center;justify-content:space-between}
    .hdr-logo{font-size:18px;font-weight:700}
    .hdr-admin{font-size:12px;opacity:.85;background:rgba(255,255,255,.2);
      padding:3px 10px;border-radius:20px}
    .hdr-date{font-size:12px;opacity:.7;margin-top:4px}

    /* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
    .page{padding:14px 14px 20px;display:none;animation:fi .25s}
    .page.active{display:block}
    @keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card{background:var(--card);border-radius:var(--r);padding:18px 16px;
      margin-bottom:14px;box-shadow:var(--shadow)}
    .card-title{font-size:15px;font-weight:600;margin-bottom:14px;
      display:flex;align-items:center;gap:8px}
    .badge{font-size:11px;font-weight:500;padding:2px 8px;border-radius:20px;
      background:#e7f8ef;color:var(--green-dk)}
    .badge.blue{background:#e8f0fb;color:var(--blue-dk)}

    /* ‚îÄ‚îÄ Search bar ‚îÄ‚îÄ */
    .search-row{display:flex;gap:8px;align-items:flex-end;margin-bottom:16px}
    .search-row .fg{flex:1;margin:0}
    .btn-search{padding:11px 14px;background:var(--green);color:#fff;border:none;
      border-radius:10px;font-size:14px;font-weight:600;font-family:'Prompt',sans-serif;
      cursor:pointer;white-space:nowrap;transition:background .15s}
    .btn-search:active{background:var(--green-dk)}
    .btn-search.blue{background:var(--blue)}
    .btn-search.blue:active{background:var(--blue-dk)}

    /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
    .fg{margin-bottom:14px}
    label.lbl{display:block;font-size:12px;font-weight:500;color:var(--muted);margin-bottom:5px}
    label.lbl .req{color:#ef4444;margin-left:2px}
    .ctrl{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;
      font-size:15px;font-family:'Prompt',sans-serif;color:var(--text);background:#fff;
      transition:border-color .2s;-webkit-appearance:none;appearance:none}
    .ctrl:focus{outline:none;border-color:var(--green)}
    select.ctrl{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right 10px center;
      background-size:22px;padding-right:34px}
    textarea.ctrl{resize:none}
    .amt-wrap{position:relative}
    .amt-pfx{position:absolute;left:13px;top:50%;transform:translateY(-50%);
      font-size:15px;color:var(--muted);pointer-events:none}
    .amt-wrap .ctrl{padding-left:28px}

    /* ‚îÄ‚îÄ Slip Upload ‚îÄ‚îÄ */
    .slip-section{border:2px dashed var(--border);border-radius:12px;
      padding:16px;text-align:center;cursor:pointer;transition:border-color .2s;
      margin-bottom:14px;position:relative}
    .slip-section:hover{border-color:var(--green)}
    .slip-section.has-img{border-style:solid;border-color:var(--green)}
    .slip-ico{font-size:32px;margin-bottom:6px}
    .slip-txt{font-size:13px;color:var(--muted)}
    .slip-section input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
    #slip-preview-d,#slip-preview-b{
      width:100%;max-height:240px;object-fit:contain;border-radius:8px;margin-bottom:8px;display:none}

    /* ‚îÄ‚îÄ Verify Badge ‚îÄ‚îÄ */
    .verify-box{border-radius:10px;padding:10px 12px;margin-bottom:14px;display:none;
      font-size:13px;font-weight:500;align-items:center;gap:8px}
    .verify-box.ok{background:#e7f8ef;color:#00703c;display:flex}
    .verify-box.delay{background:#fff8e1;color:#b45309;display:flex}
    .verify-box.fail{background:#fef2f2;color:#b91c1c;display:flex}
    .verify-box.skip{background:#f3f4f6;color:var(--muted);display:flex}
    .v-ico{font-size:20px}

    /* ‚îÄ‚îÄ Verify button ‚îÄ‚îÄ */
    .btn-verify{width:100%;padding:10px;background:#f3f4f6;color:var(--text);
      border:1.5px solid var(--border);border-radius:10px;font-size:14px;
      font-weight:600;font-family:'Prompt',sans-serif;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:6px;
      margin-bottom:12px;transition:all .15s}
    .btn-verify:hover{border-color:var(--green);color:var(--green)}
    .btn-verify:disabled{opacity:.5;cursor:not-allowed}

    /* ‚îÄ‚îÄ Submit ‚îÄ‚îÄ */
    .btn{width:100%;padding:13px;border:none;border-radius:11px;font-size:16px;
      font-weight:600;font-family:'Prompt',sans-serif;cursor:pointer;transition:all .15s;
      display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-primary{background:var(--green);color:#fff}
    .btn-primary:active{transform:scale(.97);background:var(--green-dk)}
    .btn-primary:disabled{background:#9de0be;cursor:not-allowed;transform:none}
    .btn-primary.blue{background:var(--blue)}
    .btn-primary.blue:active{background:var(--blue-dk)}
    .btn-primary.blue:disabled{background:#a3c4e8}

    /* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);
      width:100%;max-width:480px;height:var(--nav-h);background:#fff;
      border-top:1px solid var(--border);display:flex;z-index:300;
      box-shadow:0 -3px 12px rgba(0,0,0,.07)}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;
      justify-content:center;gap:3px;cursor:pointer;padding:6px 0;transition:background .15s}
    .nav-item:active{background:#f3f4f6}
    .nav-icon{font-size:27px;transition:transform .2s}
    .nav-label{font-size:11px;font-weight:500;color:var(--muted);transition:color .2s}
    .nav-item.active .nav-label{color:var(--green);font-weight:700}
    .nav-item.active .nav-icon{transform:scale(1.12)}
    .nav-item.active.blue-nav .nav-label{color:var(--blue)}
    .nav-divider{width:1px;background:var(--border);margin:10px 0;align-self:stretch}

    /* ‚îÄ‚îÄ Recent ‚îÄ‚îÄ */
    .recent-row{display:flex;justify-content:space-between;align-items:center;
      padding:10px 0;border-bottom:1px solid #f3f4f6}
    .recent-row:last-child{border:none}
    .rr-name{font-size:14px;font-weight:500}
    .rr-meta{font-size:11px;color:var(--muted);margin-top:2px}
    .rr-amt{font-size:15px;font-weight:700;color:var(--green);white-space:nowrap;margin-left:8px}
    .rr-amt.blue{color:var(--blue)}
    .empty{text-align:center;padding:24px 20px;color:var(--muted)}
    .empty .ico{font-size:36px;margin-bottom:8px}
    .empty p{font-size:13px}

    /* ‚îÄ‚îÄ Auth err / Toast ‚îÄ‚îÄ */
    .auth-err{color:#ef4444;font-size:13px;margin-bottom:12px;display:none}
    .pin-ctrl{text-align:center;letter-spacing:10px;font-size:22px;font-weight:600}
    .toast{position:fixed;bottom:calc(var(--nav-h) + 14px);left:50%;
      transform:translateX(-50%) translateY(16px);background:#1a1a2e;color:#fff;
      padding:11px 22px;border-radius:30px;font-size:14px;opacity:0;
      transition:all .3s;z-index:9999;pointer-events:none;white-space:nowrap;
      box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.ok{background:var(--green)}
    .toast.err{background:#ef4444}

    /* ‚îÄ‚îÄ Results count ‚îÄ‚îÄ */
    .result-count{font-size:12px;color:var(--muted);margin:-6px 0 10px;padding-left:2px}
  </style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="logo">üí∞</div>
  <div class="ttl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</div>
  <div class="sub">‡∏ü‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
  <div class="spinner"></div>
</div>

<!-- Auth -->
<div id="auth">
  <div class="auth-card">
    <div class="auth-head">
      <div class="ico">üîê</div>
      <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h2>
      <p>‡∏Å‡∏£‡∏≠‡∏Å PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° LINE ‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
    </div>
    <div class="fg">
      <label class="lbl">LINE Display Name</label>
      <input type="text" class="ctrl" id="auth-name" readonly />
    </div>
    <div class="fg">
      <label class="lbl">PIN <span class="req">*</span></label>
      <input type="password" class="ctrl pin-ctrl" id="auth-pin"
             placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢" maxlength="10" inputmode="numeric" />
    </div>
    <div class="auth-err" id="auth-err"></div>
    <button class="btn btn-primary" id="auth-btn" onclick="doVerifyPin()">
      <span>üîì</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    </button>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="header">
    <div class="hdr-row">
      <div class="hdr-logo">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</div>
      <div class="hdr-admin" id="hdr-admin">‚Äî</div>
    </div>
    <div class="hdr-date" id="hdr-date"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê PAGE: ‡∏°‡∏±‡∏î‡∏à‡∏≥ ‚ïê‚ïê‚ïê‚ïê -->
  <div class="page active" id="page-deposit">
    <div class="card">
      <div class="card-title">üì• ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥ <span class="badge">Deposit</span></div>

      <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô -->
      <div class="search-row">
        <div class="fg">
          <label class="lbl">üóì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
          <input type="date" class="ctrl" id="d-event-date" />
        </div>
        <button class="btn-search" onclick="searchQuotes('deposit')">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="result-count" id="d-result-count"></div>

      <div class="fg">
        <label class="lbl">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Quote <span class="req">*</span></label>
        <select class="ctrl" id="d-quote">
          <option value="">‚Äî ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Quote ‚Äî</option>
        </select>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <input type="text" class="ctrl" id="d-customer" placeholder="‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ / ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á" />
      </div>

      <!-- Slip Upload -->
      <label class="lbl">üìé ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</label>
      <div class="slip-section" id="slip-zone-d">
        <img id="slip-preview-d" alt="slip" />
        <div id="slip-placeholder-d">
          <div class="slip-ico">üßæ</div>
          <div class="slip-txt">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
        </div>
        <input type="file" accept="image/*" id="slip-file-d" onchange="onSlipSelected('d')" />
      </div>
      <button class="btn-verify" id="d-verify-btn" onclick="doVerifySlip('d')" disabled>
        <span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </button>
      <div class="verify-box" id="d-verify-box">
        <span class="v-ico" id="d-v-ico">‚Äî</span>
        <span id="d-v-msg">‚Äî</span>
      </div>

      <div class="fg">
        <label class="lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ö‡∏≤‡∏ó) <span class="req">*</span></label>
        <div class="amt-wrap">
          <span class="amt-pfx">‡∏ø</span>
          <input type="number" class="ctrl" id="d-amount"
                 placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô <span class="req">*</span></label>
        <input type="date" class="ctrl" id="d-date" />
      </div>
      <div class="fg">
        <label class="lbl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea class="ctrl" id="d-note" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶"></textarea>
      </div>
      <button class="btn btn-primary" id="d-btn" onclick="doSubmitDeposit()">
        <span>‚úÖ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE
      </button>
    </div>

    <div class="card">
      <div class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏°‡∏±‡∏î‡∏à‡∏≥)</div>
      <div id="recent-deposit"><div class="empty"><div class="ico">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê PAGE: ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-balance">
    <div class="card">
      <div class="card-title">üí∏ ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span class="badge blue">Balance</span></div>

      <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô -->
      <div class="search-row">
        <div class="fg">
          <label class="lbl">üóì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
          <input type="date" class="ctrl" id="b-event-date" />
        </div>
        <button class="btn-search blue" onclick="searchQuotes('balance')">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="result-count" id="b-result-count"></div>

      <div class="fg">
        <label class="lbl">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Quote <span class="req">*</span></label>
        <select class="ctrl" id="b-quote">
          <option value="">‚Äî ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Quote ‚Äî</option>
        </select>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <input type="text" class="ctrl" id="b-customer" placeholder="‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ / ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á" />
      </div>

      <!-- Slip Upload -->
      <label class="lbl">üìé ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</label>
      <div class="slip-section" id="slip-zone-b">
        <img id="slip-preview-b" alt="slip" />
        <div id="slip-placeholder-b">
          <div class="slip-ico">üßæ</div>
          <div class="slip-txt">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
        </div>
        <input type="file" accept="image/*" id="slip-file-b" onchange="onSlipSelected('b')" />
      </div>
      <button class="btn-verify" id="b-verify-btn" onclick="doVerifySlip('b')" disabled>
        <span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </button>
      <div class="verify-box" id="b-verify-box">
        <span class="v-ico" id="b-v-ico">‚Äî</span>
        <span id="b-v-msg">‚Äî</span>
      </div>

      <div class="fg">
        <label class="lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) <span class="req">*</span></label>
        <div class="amt-wrap">
          <span class="amt-pfx">‡∏ø</span>
          <input type="number" class="ctrl" id="b-amount"
                 placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô <span class="req">*</span></label>
        <input type="date" class="ctrl" id="b-date" />
      </div>
      <div class="fg">
        <label class="lbl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea class="ctrl" id="b-note" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶"></textarea>
      </div>
      <button class="btn btn-primary blue" id="b-btn" onclick="doSubmitBalance()">
        <span>‚úÖ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE
      </button>
    </div>

    <div class="card">
      <div class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</div>
      <div id="recent-balance"><div class="empty"><div class="ico">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div></div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-item active" id="nav-deposit" onclick="switchPage('deposit')">
      <div class="nav-icon">üì•</div>
      <div class="nav-label">‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-item blue-nav" id="nav-balance" onclick="switchPage('balance')">
      <div class="nav-icon">üí∏</div>
      <div class="nav-label">‡∏£‡∏±‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
    </div>
  </nav>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LIFF_ID = '2009224163-ZyLVfnoq';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyfiO_3KO4I5KY6d-nmuz9jZjql0C3T9hD9K2oAkufjwIBYbma2lYpVHoYRyQTym2gHog/exec';
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let lineUserId  = '';
let adminName   = '';
let slipData    = { d: null, b: null };   // slip verify result per tab
let slipFile    = { d: null, b: null };   // base64 file data per tab

/* ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }

    const profile = await liff.getProfile();
    lineUserId = profile.userId;
    document.getElementById('auth-name').value = profile.displayName;
    setTodayDates();
    setHeaderDate();

    const res = await api({ action: 'checkAdmin', lineUserId });
    if (res.status === 'approved') {
      adminName = res.name;
      await afterAuth();
    } else {
      hideLoading();
      showEl('auth', 'flex');
    }
  } catch (err) {
    console.error(err);
    if (['localhost','127.0.0.1'].includes(location.hostname)) {
      setTodayDates(); setHeaderDate(); hideLoading(); showEl('app','block');
    } else {
      toast('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà','err'); hideLoading();
    }
  }
}

async function afterAuth() {
  document.getElementById('hdr-admin').textContent = 'üë§ ' + adminName;
  await loadRecent();
  hideLoading();
  showEl('auth','none');
  showEl('app','block');
}

/* ‚îÄ‚îÄ‚îÄ Auth PIN ‚îÄ‚îÄ‚îÄ */
async function doVerifyPin() {
  const pin = document.getElementById('auth-pin').value.trim();
  if (!pin) { showAuthErr('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å PIN'); return; }
  setBtnLoad('auth-btn', true);
  try {
    const res = await api({ action: 'registerAdmin', lineUserId, pin });
    if (res.status === 'approved') { adminName = res.name; await afterAuth(); }
    else if (res.status === 'already_linked') showAuthErr('LINE ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß');
    else showAuthErr('PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
  } catch(e) { showAuthErr('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'); }
  setBtnLoad('auth-btn', false, 'üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
}

/* ‚îÄ‚îÄ‚îÄ ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å input[type=date] ‚Üí yyyy-MM-dd (‡∏Ñ.‡∏®. ‡πÄ‡∏™‡∏°‡∏≠) ‚îÄ‚îÄ‚îÄ */
function normDateInput(val) {
  if (!val) return '';
  // input[type=date] ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô "yyyy-MM-dd"
  // ‡πÅ‡∏ï‡πà iOS/Android ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏ä‡πà‡∏ô "2569-02-27"
  const parts = val.split('-');
  if (parts.length === 3) {
    let y = parseInt(parts[0], 10);
    if (y > 2500) y -= 543;          // ‡∏û.‡∏®. ‚Üí ‡∏Ñ.‡∏®.
    return y + '-' + parts[1] + '-' + parts[2];
  }
  return val;
}

/* ‚îÄ‚îÄ‚îÄ Search Quotes by Event Date ‚îÄ‚îÄ‚îÄ */
async function searchQuotes(tab) {
  const p    = tab === 'deposit' ? 'd' : 'b';
  const raw  = document.getElementById(p + '-event-date').value;
  const date = normDateInput(raw);   // ‚Üê ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®.‚Üí‡∏Ñ.‡∏®. ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
  const sel  = document.getElementById(p + '-quote');
  const cnt  = document.getElementById(p + '-result-count');

  if (!date) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô','err'); return; }

  // DEBUG ‚Äî ‡∏î‡∏π‡∏Ñ‡πà‡∏≤ date ‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á GAS
  console.log('[LIFF] raw="' + raw + '"  ‚Üí  date="' + date + '"');
  cnt.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶ [' + date + ']';

  cnt.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶';
  sel.innerHTML = '<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option>';

  try {
    const url = `${GAS_URL}?action=getQuotesByDate&date=${date}`;
    const res = await (await fetch(url)).json();
    const quotes = res.quotes || [];

    sel.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Quote ‚Äî</option>';
    quotes.forEach(q => sel.add(new Option(q.label, q.quoteNo, false, false)));

    cnt.textContent = quotes.length
      ? `‡∏û‡∏ö ${quotes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏∏‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)`
      : '‚Äî ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ ‚Äî';

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    if (quotes.length === 1) {
      sel.value = quotes[0].quoteNo;
      document.getElementById(p + '-customer').value = quotes[0].customer;
    }
  } catch(e) { cnt.textContent = ''; toast('‚ùå ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','err'); }
}

/* ‚îÄ‚îÄ‚îÄ Quote change ‚Üí auto-fill customer ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
  ['d','b'].forEach(p => {
    document.getElementById(p + '-quote').addEventListener('change', function() {
      const opt = this.options[this.selectedIndex];
      if (opt && opt.text && opt.text.includes(' ‚Äî ')) {
        const cus = opt.text.split(' ‚Äî ').slice(1).join(' ‚Äî ');
        document.getElementById(p + '-customer').value = cus;
      }
    });
  });
});

/* ‚îÄ‚îÄ‚îÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ QR Code ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢ jsQR ‚îÄ‚îÄ‚îÄ */
function detectQRCode(dataUrl) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = function() {
      try {
        const canvas  = document.createElement('canvas');
        canvas.width  = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        resolve(code ? code.data : null);   // ‡∏Ñ‡∏∑‡∏ô QR string ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠, null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
      } catch(e) { resolve(null); }
    };
    img.onerror = () => resolve(null);
    img.src = dataUrl;
  });
}

/* ‚îÄ‚îÄ‚îÄ Slip Selected ‚Üí ‡∏ï‡∏£‡∏ß‡∏à QR ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á SlipOK ‚îÄ‚îÄ‚îÄ */
function onSlipSelected(p) {
  const file = document.getElementById('slip-file-' + p).files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = e.target.result.split(',')[1];
    slipFile[p] = { data: base64, mimeType: file.type, name: file.name };

    // Preview
    const preview = document.getElementById('slip-preview-' + p);
    preview.src = e.target.result;
    preview.style.display = 'block';
    document.getElementById('slip-placeholder-' + p).style.display = 'none';
    document.getElementById('slip-zone-' + p).classList.add('has-img');

    slipData[p] = null;
    document.getElementById(p + '-verify-btn').disabled = true;
    showVerifyBox(p, 'skip', 'üîç', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ QR code‚Ä¶');

    // ‚îÄ‚îÄ Step 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ QR code ‡∏ù‡∏±‡πà‡∏á browser ‚îÄ‚îÄ
    const qrData = await detectQRCode(e.target.result);

    if (qrData) {
      // ‡∏°‡∏µ QR ‚Üí ‡∏™‡πà‡∏á SlipOK ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      showVerifyBox(p, 'skip', '‚è≥', '‡∏û‡∏ö QR code ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à SlipOK‚Ä¶');
      doVerifySlip(p);
    } else {
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ QR ‚Üí ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
      showVerifyBox(p, 'skip', 'üìù', '‡πÑ‡∏°‡πà‡∏û‡∏ö QR code ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á');
      document.getElementById(p + '-verify-btn').disabled = false;  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠
    }
  };
  reader.readAsDataURL(file);
}

/* ‚îÄ‚îÄ‚îÄ Verify Slip ‚îÄ‚îÄ‚îÄ */
async function doVerifySlip(p) {
  if (!slipFile[p]) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô','err'); return; }

  const btn = document.getElementById(p + '-verify-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0 auto"></div>';

  try {
    const res = await api({ action: 'verifySlip', file: slipFile[p] });

    if (res.status !== 'ok' || !res.result) {
      toast('‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res.message || ''), 'err');
      showVerifyBox(p, 'fail', '‚ùå', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      const r = res.result;
      slipData[p] = r;

      if (r.verified) {
        showVerifyBox(p, 'ok', '‚úÖ', `VERIFIED ‚Äî ‡∏ø${fmt(r.depositAmount)} (${r.sendingBank || '?'} ‚Üí ‡∏£‡∏±‡∏ö)`);
        // Auto-fill amount & date
        if (r.depositAmount > 0)  document.getElementById(p + '-amount').value = r.depositAmount;
        if (r.depositDate)         document.getElementById(p + '-date').value   = r.depositDate;
        toast('‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'ok');

      } else if (r.verifyStatus === 'DELAY') {
        showVerifyBox(p, 'delay', '‚è≥', `DELAY (‡∏£‡∏≠ ${r.delayMin || '?'} ‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî ` + r.verifyMessage);
        if (r.depositAmount > 0) document.getElementById(p + '-amount').value = r.depositAmount;
        if (r.depositDate)        document.getElementById(p + '-date').value   = r.depositDate;
        toast('‚è≥ ‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (DELAY)', '');

      } else {
        showVerifyBox(p, 'fail', '‚ùå', `FAILED [${r.verifyCode}] ‚Äî ` + r.verifyMessage);
        toast('‚ö†Ô∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ' + r.verifyMessage, 'err');
      }
    }
  } catch(e) { toast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'err'); }

  btn.disabled = false;
  btn.innerHTML = '<span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
}

function showVerifyBox(p, type, ico, msg) {
  const box  = document.getElementById(p + '-verify-box');
  const icoEl = document.getElementById(p + '-v-ico');
  const msgEl = document.getElementById(p + '-v-msg');
  box.className = 'verify-box ' + type;
  icoEl.textContent = ico;
  msgEl.textContent = msg;
}

/* ‚îÄ‚îÄ‚îÄ Submit Deposit ‚îÄ‚îÄ‚îÄ */
async function doSubmitDeposit() {
  const quoteNo  = v('d-quote');
  const customer = v('d-customer');
  const amount   = v('d-amount');
  const date     = v('d-date');
  const note     = v('d-note');

  if (!quoteNo || !amount || !date) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  if (+amount <= 0) { toast('‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0','err'); return; }

  setBtnLoad('d-btn', true);
  try {
    const slip = buildSlipPayload('d');
    const res  = await api({ action:'saveDeposit', lineUserId, adminName,
                              quoteNo, customer, amount:+amount, date, note, slip });
    if (res.status === 'success') {
      toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥ + ‡πÅ‡∏à‡πâ‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß', 'ok');
      resetForm('d');
      await loadRecent();
    } else { toast('‚ùå ' + (res.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'), 'err'); }
  } catch(e) { toast('‚ùå ' + e.message, 'err'); }
  setBtnLoad('d-btn', false, '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE');
}

/* ‚îÄ‚îÄ‚îÄ Submit Balance ‚îÄ‚îÄ‚îÄ */
async function doSubmitBalance() {
  const quoteNo  = v('b-quote');
  const customer = v('b-customer');
  const amount   = v('b-amount');
  const date     = v('b-date');
  const note     = v('b-note');

  if (!quoteNo || !amount || !date) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  if (+amount <= 0) { toast('‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0','err'); return; }

  setBtnLoad('b-btn', true);
  try {
    const slip = buildSlipPayload('b');
    const res  = await api({ action:'saveBalance', lineUserId, adminName,
                              quoteNo, customer, amount:+amount, date, note, slip });
    if (res.status === 'success') {
      toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ + ‡πÅ‡∏à‡πâ‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß', 'ok');
      resetForm('b');
      await loadRecent();
    } else { toast('‚ùå ' + (res.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'), 'err'); }
  } catch(e) { toast('‚ùå ' + e.message, 'err'); }
  setBtnLoad('b-btn', false, '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE');
}

function buildSlipPayload(p) {
  const r = slipData[p];
  if (!r) return { verifyStatus: 'SKIPPED' };
  const d = r.slipData || {};
  return {
    verifyStatus:         r.verifyStatus,
    verifyCode:           r.verifyCode,
    verifyMessage:        r.verifyMessage,
    transTimestamp:       d.transTimestamp    || '',
    transRef:             d.transRef          || '',
    transDate:            d.transDate         || '',
    transTime:            d.transTime         || '',
    sendingBank:          d.sendingBank        || '',
    receivingBank:        d.receivingBank      || '',
    transFeeAmount:       d.transFeeAmount     || 0,
    senderDisplayName:    (d.sender && d.sender.displayName) || '',
    senderName:           (d.sender && d.sender.name)        || '',
    senderAccountValue:   (d.sender && d.sender.account && d.sender.account.value) || '',
    receiverDisplayName:  (d.receiver && d.receiver.displayName) || '',
    receiverName:         (d.receiver && d.receiver.name)        || '',
    receiverAccountValue: (d.receiver && d.receiver.account && d.receiver.account.value) || '',
    qrcodeData:           r.qrcodeData || ''
  };
}

/* ‚îÄ‚îÄ‚îÄ Load Recent ‚îÄ‚îÄ‚îÄ */
async function loadRecent() {
  try {
    const res = await api({ action:'getRecent', limit:5 });
    renderRecent('recent-deposit', res.deposits||[], false);
    renderRecent('recent-balance', res.balances||[], true);
  } catch(e) {}
}

function renderRecent(id, items, isBlue) {
  const el = document.getElementById(id);
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="ico">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>';
    return;
  }
  el.innerHTML = items.map(r => `
    <div class="recent-row">
      <div>
        <div class="rr-name">${r.quoteNo} ‚Äî ${r.customer||'‚Äî'}</div>
        <div class="rr-meta">${r.date} ¬∑ ${r.by||'‚Äî'}</div>
      </div>
      <div class="rr-amt${isBlue?' blue':''}">‡∏ø${fmt(r.amount)}</div>
    </div>`).join('');
}

/* ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ */
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('nav-'+page).classList.add('active');
  window.scrollTo(0,0);
}

/* ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ */
async function api(payload) {
  const res = await fetch(GAS_URL, {
    method:'POST', headers:{'Content-Type':'text/plain'},
    body: JSON.stringify(payload)
  });
  return res.json();
}

/* ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ */
function v(id) { return document.getElementById(id).value.trim(); }

function setTodayDates() {
  const t = new Date().toISOString().split('T')[0];
  ['d-date','b-date'].forEach(id => { const el=document.getElementById(id); if(el) el.value=t; });
}
function setHeaderDate() {
  const el = document.getElementById('hdr-date');
  if (el) el.textContent = new Date().toLocaleDateString('th-TH',
    { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}
function hideLoading() {
  const el = document.getElementById('loading');
  el.style.opacity = '0';
  setTimeout(() => el.style.display='none', 420);
}
function showEl(id, display) { document.getElementById(id).style.display = display; }
function showAuthErr(msg) {
  const el = document.getElementById('auth-err');
  el.textContent = msg; el.style.display = 'block';
}
function resetForm(p) {
  ['quote','customer','amount','note'].forEach(f => {
    const el = document.getElementById(p+'-'+f);
    if (!el) return;
    el.tagName==='SELECT' ? (el.selectedIndex=0) : (el.value='');
  });
  setTodayDates();
  // reset slip
  slipData[p] = null; slipFile[p] = null;
  document.getElementById('slip-preview-'+p).style.display = 'none';
  document.getElementById('slip-placeholder-'+p).style.display = 'block';
  document.getElementById('slip-zone-'+p).classList.remove('has-img');
  document.getElementById('slip-file-'+p).value = '';
  document.getElementById(p+'-verify-btn').disabled = true;
  document.getElementById(p+'-verify-box').className = 'verify-box';
  document.getElementById(p+'-result-count').textContent = '';
}
function setBtnLoad(id, loading, label) {
  const btn = document.getElementById(id);
  btn.disabled = loading;
  if (loading) btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div>';
  else if (label) btn.innerHTML = label;
}
function fmt(n) { return Number(n||0).toLocaleString('th-TH',{minimumFractionDigits:2}); }
let _tt;
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast '+(type||'');
  void el.offsetWidth; el.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(()=>el.classList.remove('show'), 3200);
}

init();
</script>
</body>
</html>
