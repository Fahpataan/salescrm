<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î ‚Äî ‡∏ü‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --green:  #0ea5e9; --green-dk: #0284c7;
      --blue:   #0369a1; --blue-dk:  #075985;
      --bg:     #f0f6fb; --card: #fff;
      --text:   #0f172a; --muted: #6b7280;
      --border: #e2e8f0; --nav-h: 66px; --r: 14px;
      --shadow: 0 2px 12px rgba(14,165,233,.10);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Prompt',sans-serif;background:var(--bg);color:var(--text);
         min-height:100vh;max-width:480px;margin:0 auto}

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    #loading{position:fixed;inset:0;background:linear-gradient(160deg,#0ea5e9,#0284c7);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:9999;color:#fff;transition:opacity .4s}
    #loading .logo{font-size:52px;margin-bottom:10px}
    #loading .ttl{font-size:20px;font-weight:600}
    #loading .sub{font-size:13px;opacity:.75;margin-top:4px}
    .spinner{width:34px;height:34px;margin-top:28px;border:3px solid rgba(255,255,255,.3);
      border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
    #auth{display:none;min-height:100vh;padding:32px 20px;
      align-items:center;justify-content:center;flex-direction:column}
    .auth-card{background:#fff;border-radius:20px;padding:32px 24px;width:100%;box-shadow:var(--shadow)}
    .auth-head{text-align:center;margin-bottom:24px}
    .auth-head .ico{font-size:54px}
    .auth-head h2{font-size:20px;font-weight:600;margin-top:8px}
    .auth-head p{font-size:13px;color:var(--muted);margin-top:4px}

    /* ‚îÄ‚îÄ App ‚îÄ‚îÄ */
    #app{display:none;min-height:100vh;padding-bottom:var(--nav-h)}
    .header{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;
      padding:14px 20px 12px;position:sticky;top:0;z-index:200}
    .hdr-row{display:flex;align-items:center;justify-content:space-between}
    .hdr-logo{font-size:18px;font-weight:700}
    .hdr-admin{font-size:12px;opacity:.85;background:rgba(255,255,255,.2);
      padding:3px 10px;border-radius:20px}
    .hdr-date{font-size:12px;opacity:.7;margin-top:4px}

    /* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
    .page{padding:14px 14px 20px;display:none;animation:fi .25s}
    .page.active{display:block}
    @keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card{background:var(--card);border-radius:var(--r);padding:18px 16px;
      margin-bottom:14px;box-shadow:var(--shadow)}
    .card-title{font-size:15px;font-weight:600;margin-bottom:14px;
      display:flex;align-items:center;gap:8px}
    .badge{font-size:11px;font-weight:500;padding:2px 8px;border-radius:20px;
      background:#e7f8ef;color:var(--green-dk)}
    .badge.blue{background:#e8f0fb;color:var(--blue-dk)}

    /* ‚îÄ‚îÄ Search bar ‚îÄ‚îÄ */
    .search-row{display:flex;gap:8px;align-items:flex-end;margin-bottom:16px}
    .search-row .fg{flex:1;margin:0}
    .btn-search{padding:11px 14px;background:var(--green);color:#fff;border:none;
      border-radius:10px;font-size:14px;font-weight:600;font-family:'Prompt',sans-serif;
      cursor:pointer;white-space:nowrap;transition:background .15s}
    .btn-search:active{background:var(--green-dk)}
    .btn-search.blue{background:var(--blue)}
    .btn-search.blue:active{background:var(--blue-dk)}

    /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
    .fg{margin-bottom:14px}
    label.lbl{display:block;font-size:12px;font-weight:500;color:var(--muted);margin-bottom:5px}
    label.lbl .req{color:#ef4444;margin-left:2px}
    .ctrl{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;
      font-size:15px;font-family:'Prompt',sans-serif;color:var(--text);background:#fff;
      transition:border-color .2s;-webkit-appearance:none;appearance:none}
    .ctrl:focus{outline:none;border-color:var(--green)}
    select.ctrl{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right 10px center;
      background-size:22px;padding-right:34px}
    textarea.ctrl{resize:none}
    .amt-wrap{position:relative}
    .amt-pfx{position:absolute;left:13px;top:50%;transform:translateY(-50%);
      font-size:15px;color:var(--muted);pointer-events:none}
    .amt-wrap .ctrl{padding-left:28px}

    /* ‚îÄ‚îÄ Slip Upload ‚îÄ‚îÄ */
    .slip-section{border:2px dashed var(--border);border-radius:12px;
      padding:16px;text-align:center;cursor:pointer;transition:border-color .2s;
      margin-bottom:14px;position:relative}
    .slip-section:hover{border-color:var(--green)}
    .slip-section.has-img{border-style:solid;border-color:var(--green)}
    .slip-ico{font-size:32px;margin-bottom:6px}
    .slip-txt{font-size:13px;color:var(--muted)}
    .slip-section input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
    #slip-preview-d,#slip-preview-b{
      width:100%;max-height:240px;object-fit:contain;border-radius:8px;margin-bottom:8px;display:none}

    /* ‚îÄ‚îÄ Verify Badge ‚îÄ‚îÄ */
    .verify-box{border-radius:10px;padding:10px 12px;margin-bottom:14px;display:none;
      font-size:13px;font-weight:500;align-items:center;gap:8px}
    .verify-box.ok{background:#e7f8ef;color:#00703c;display:flex}
    .verify-box.delay{background:#fff8e1;color:#b45309;display:flex}
    .verify-box.fail{background:#fef2f2;color:#b91c1c;display:flex}
    .verify-box.skip{background:#f3f4f6;color:var(--muted);display:flex}
    .v-ico{font-size:20px}

    /* ‚îÄ‚îÄ Verify button ‚îÄ‚îÄ */
    .btn-verify{width:100%;padding:10px;background:#f3f4f6;color:var(--text);
      border:1.5px solid var(--border);border-radius:10px;font-size:14px;
      font-weight:600;font-family:'Prompt',sans-serif;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:6px;
      margin-bottom:12px;transition:all .15s}
    .btn-verify:hover{border-color:var(--green);color:var(--green)}
    .btn-verify:disabled{opacity:.5;cursor:not-allowed}

    /* ‚îÄ‚îÄ Submit ‚îÄ‚îÄ */
    .btn{width:100%;padding:13px;border:none;border-radius:11px;font-size:16px;
      font-weight:600;font-family:'Prompt',sans-serif;cursor:pointer;transition:all .15s;
      display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-primary{background:var(--green);color:#fff}
    .btn-primary:active{transform:scale(.97);background:var(--green-dk)}
    .btn-primary:disabled{background:#9de0be;cursor:not-allowed;transform:none}
    .btn-primary.blue{background:var(--blue)}
    .btn-primary.blue:active{background:var(--blue-dk)}
    .btn-primary.blue:disabled{background:#a3c4e8}

    /* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);
      width:100%;max-width:480px;height:var(--nav-h);background:#fff;
      border-top:1px solid var(--border);display:flex;z-index:300;
      box-shadow:0 -3px 12px rgba(0,0,0,.07)}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;
      justify-content:center;gap:3px;cursor:pointer;padding:6px 0;transition:background .15s}
    .nav-item:active{background:#f3f4f6}
    .nav-icon{font-size:27px;transition:transform .2s}
    .nav-label{font-size:11px;font-weight:500;color:var(--muted);transition:color .2s}
    .nav-item.active .nav-label{color:var(--green);font-weight:700}
    .nav-item.active .nav-icon{transform:scale(1.12)}
    .nav-item.active.blue-nav .nav-label{color:var(--blue)}
    .nav-divider{width:1px;background:var(--border);margin:10px 0;align-self:stretch}

    /* ‚îÄ‚îÄ Recent ‚îÄ‚îÄ */
    .recent-row{display:flex;justify-content:space-between;align-items:center;
      padding:10px 0;border-bottom:1px solid #f3f4f6}
    .recent-row:last-child{border:none}
    .rr-name{font-size:14px;font-weight:500}
    .rr-meta{font-size:11px;color:var(--muted);margin-top:2px}
    .rr-amt{font-size:15px;font-weight:700;color:var(--green);white-space:nowrap;margin-left:8px}
    .rr-amt.blue{color:var(--blue)}
    .empty{text-align:center;padding:24px 20px;color:var(--muted)}
    .empty .ico{font-size:36px;margin-bottom:8px}
    .empty p{font-size:13px}

    /* ‚îÄ‚îÄ Auth err / Toast ‚îÄ‚îÄ */
    .auth-err{color:#ef4444;font-size:13px;margin-bottom:12px;display:none}
    .pin-ctrl{text-align:center;letter-spacing:10px;font-size:22px;font-weight:600}
    .toast{position:fixed;bottom:calc(var(--nav-h) + 14px);left:50%;
      transform:translateX(-50%) translateY(16px);background:#1a1a2e;color:#fff;
      padding:11px 22px;border-radius:30px;font-size:14px;opacity:0;
      transition:all .3s;z-index:9999;pointer-events:none;white-space:nowrap;
      box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.ok{background:var(--green)}
    .toast.err{background:#ef4444}

    /* ‚îÄ‚îÄ Results count ‚îÄ‚îÄ */
    .result-count{font-size:12px;color:var(--muted);margin:-6px 0 10px;padding-left:2px}

    /* ‚îÄ‚îÄ Payment Method Radio ‚îÄ‚îÄ */
    .pay-method-row{display:flex;gap:8px;flex-wrap:wrap}
    .pay-opt{display:flex;align-items:center;justify-content:center;gap:5px;
      font-size:13px;font-weight:500;cursor:pointer;flex:1;min-width:70px;
      padding:9px 8px;border:1.5px solid var(--border);border-radius:9px;
      transition:all .15s;color:var(--muted)}
    .pay-opt input[type=radio]{display:none}
    .pay-opt.selected{border-color:var(--blue);background:#e8f0fb;color:var(--blue-dk);font-weight:700}

    /* ‚îÄ‚îÄ Compare Message ‚îÄ‚îÄ */
    .compare-msg{border-radius:10px;padding:10px 13px;font-size:13px;font-weight:500;
      margin-bottom:14px;line-height:1.6;display:none}
    .compare-msg.ok{background:#e7f8ef;color:#00703c;display:block}
    .compare-msg.over{background:#fff8e1;color:#b45309;display:block}
    .compare-msg.under{background:#fef2f2;color:#b91c1c;display:block}

    /* ‚îÄ‚îÄ Locked input ‚îÄ‚îÄ */
    .ctrl[readonly]{background:#f0f9ff;color:var(--blue-dk);border-color:#bae6fd}

    #loading .logo {
  background: transparent !important; /* ‡∏•‡∏ö‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ */
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏•‡πÇ‡∏Å‡πâ */
#loading .logo img {
  width: 80px;       /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ) */
  height: 80px;      /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ */
  object-fit: contain; /* ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ö‡∏µ‡∏ö */
  border-radius: 4px; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏∏‡∏õ‡∏Å‡∏•‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) */
  box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ */
}
  </style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="logo">
    <img src="https://cdn1.sharemyimage.com/2025/10/15/Logo.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ü‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô">
  </div>
  <div class="ttl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</div>
  <div class="sub">‡∏ü‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
  <div class="spinner"></div>
</div>

<!-- Auth -->
<div id="auth">
  <div class="auth-card">
    <div class="auth-head">
      <div class="ico">üîê</div>
      <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h2>
      <p>‡∏Å‡∏£‡∏≠‡∏Å PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° LINE ‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
    </div>
    <div class="fg">
      <label class="lbl">LINE Display Name</label>
      <input type="text" class="ctrl" id="auth-name" readonly />
    </div>
    <div class="fg">
      <label class="lbl">PIN <span class="req">*</span></label>
      <input type="password" class="ctrl pin-ctrl" id="auth-pin"
             placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢" maxlength="10" inputmode="numeric" />
    </div>
    <div class="auth-err" id="auth-err"></div>
    <button class="btn btn-primary" id="auth-btn" onclick="doVerifyPin()">
      <span>üîì</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    </button>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="header">
    <div class="hdr-row">
      <div class="hdr-logo">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</div>
      <div class="hdr-admin" id="hdr-admin">‚Äî</div>
    </div>
    <div class="hdr-date" id="hdr-date"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê PAGE: ‡∏°‡∏±‡∏î‡∏à‡∏≥ ‚ïê‚ïê‚ïê‚ïê -->
  <div class="page active" id="page-deposit">
    <div class="card">
      <div class="card-title">üì• ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥ <span class="badge">Deposit</span></div>

      <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô -->
      <div class="search-row">
        <div class="fg">
          <label class="lbl">üóì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
          <input type="date" class="ctrl" id="d-event-date" />
        </div>
        <button class="btn-search" onclick="searchQuotes('deposit')">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="result-count" id="d-result-count"></div>

      <div class="fg">
        <label class="lbl">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Quote <span class="req">*</span></label>
        <select class="ctrl" id="d-quote">
          <option value="">‚Äî ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Quote ‚Äî</option>
        </select>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <input type="text" class="ctrl" id="d-customer" placeholder="‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ / ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á" />
      </div>

      <!-- Slip Upload -->
      <label class="lbl">üìé ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</label>
      <div class="slip-section" id="slip-zone-d">
        <img id="slip-preview-d" alt="slip" />
        <div id="slip-placeholder-d">
          <div class="slip-ico">üßæ</div>
          <div class="slip-txt">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
        </div>
        <input type="file" accept="image/*" id="slip-file-d" onchange="onSlipSelected('d')" />
      </div>
      <button class="btn-verify" id="d-verify-btn" onclick="doVerifySlip('d')" disabled>
        <span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </button>
      <div class="verify-box" id="d-verify-box">
        <span class="v-ico" id="d-v-ico">‚Äî</span>
        <span id="d-v-msg">‚Äî</span>
      </div>

      <div class="fg">
        <label class="lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ö‡∏≤‡∏ó) <span class="req">*</span></label>
        <div class="amt-wrap">
          <span class="amt-pfx">‡∏ø</span>
          <input type="number" class="ctrl" id="d-amount"
                 placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô <span class="req">*</span></label>
        <input type="date" class="ctrl" id="d-date" />
      </div>
      <div class="fg">
        <label class="lbl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea class="ctrl" id="d-note" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶"></textarea>
      </div>
      <button class="btn btn-primary" id="d-btn" onclick="doSubmitDeposit()">
        <span>‚úÖ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE
      </button>
    </div>

    <div class="card">
      <div class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏°‡∏±‡∏î‡∏à‡∏≥)</div>
      <div id="recent-deposit"><div class="empty"><div class="ico">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê PAGE: ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚ïê‚ïê‚ïê‚ïê -->
  <div class="page" id="page-balance">
    <div class="card">
      <div class="card-title">üí∏ ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span class="badge blue">Balance</span></div>

      <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô -->
      <div class="search-row">
        <div class="fg">
          <label class="lbl">üóì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
          <input type="date" class="ctrl" id="b-event-date" />
        </div>
        <button class="btn-search blue" onclick="searchQuotes('balance')">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="result-count" id="b-result-count"></div>

      <div class="fg">
        <label class="lbl">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Quote <span class="req">*</span></label>
        <select class="ctrl" id="b-quote">
          <option value="">‚Äî ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Quote ‚Äî</option>
        </select>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <input type="text" class="ctrl" id="b-customer" placeholder="‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ / ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á" />
      </div>

      <!-- Slip Upload -->
      <label class="lbl">üìé ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</label>
      <div class="slip-section" id="slip-zone-b">
        <img id="slip-preview-b" alt="slip" />
        <div id="slip-placeholder-b">
          <div class="slip-ico">üßæ</div>
          <div class="slip-txt">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
        </div>
        <input type="file" accept="image/*" id="slip-file-b" onchange="onBalSlipSelected_()" />
      </div>
      <button class="btn-verify" id="b-verify-btn" onclick="balReVerifySlip_()" disabled>
        <span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </button>
      <div class="verify-box" id="b-verify-box">
        <span class="v-ico" id="b-v-ico">‚Äî</span>
        <span id="b-v-msg">‚Äî</span>
      </div>

      <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ -->
      <div class="fg" id="b-pay-method-wrap">
        <label class="lbl">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ <span class="req">*</span></label>
        <div class="pay-method-row" id="b-pay-method-row">
          <label class="pay-opt selected" id="b-pay-label-transfer">
            <input type="radio" name="b-pay" value="‡πÇ‡∏≠‡∏ô" id="b-pay-transfer" checked
                   onchange="balToggleBankGroup_()"> üè¶ ‡πÇ‡∏≠‡∏ô
          </label>
          <label class="pay-opt" id="b-pay-label-cheque">
            <input type="radio" name="b-pay" value="‡πÄ‡∏ä‡πá‡∏Ñ" id="b-pay-cheque"
                   onchange="balToggleBankGroup_()"> üìÑ ‡πÄ‡∏ä‡πá‡∏Ñ
          </label>
          <label class="pay-opt" id="b-pay-label-cash">
            <input type="radio" name="b-pay" value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" id="b-pay-cash"
                   onchange="balToggleBankGroup_()"> üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
          </label>
        </div>
      </div>

      <!-- ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ä‡πá‡∏Ñ) -->
      <div class="fg" id="b-bank-group">
        <label class="lbl">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
        <select class="ctrl" id="b-bank">
          <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‚Äî</option>
          <option value="‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBank)</option>
          <option value="‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢">‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤">‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ (BAY)</option>
          <option value="‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï">‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï (TTB)</option>
          <option value="‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
          <option value="‡∏ò.‡∏Å.‡∏™.">‡∏ò.‡∏Å.‡∏™. (BAAC)</option>
          <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</option>
        </select>
      </div>

      <div class="fg">
        <label class="lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) <span class="req">*</span></label>
        <div class="amt-wrap">
          <span class="amt-pfx">‡∏ø</span>
          <input type="number" class="ctrl" id="b-amount"
                 placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="fg">
        <label class="lbl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô <span class="req">*</span></label>
        <input type="date" class="ctrl" id="b-date" />
      </div>

      <!-- ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏™‡∏•‡∏¥‡∏õ vs ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ -->
      <div class="compare-msg" id="b-compare-msg"></div>

      <div class="fg">
        <label class="lbl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea class="ctrl" id="b-note" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶"></textarea>
      </div>
      <button class="btn btn-primary blue" id="b-btn" onclick="doSubmitBalance()">
        <span>‚úÖ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE
      </button>
    </div>

    <div class="card">
      <div class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</div>
      <div id="recent-balance"><div class="empty"><div class="ico">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div></div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-item active" id="nav-deposit" onclick="switchPage('deposit')">
      <div class="nav-icon">üì•</div>
      <div class="nav-label">‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-item blue-nav" id="nav-balance" onclick="switchPage('balance')">
      <div class="nav-icon">üí∏</div>
      <div class="nav-label">‡∏£‡∏±‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
    </div>
  </nav>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LIFF_ID = '2009224163-ZyLVfnoq';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyb2dXDdvRmiXaalyNzZcouJe2NzmB5MRGYaBRP595PgpDsw3ZyGyq98fUj9bQRJKKEjg/exec';
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let lineUserId  = '';
let adminName   = '';
let slipData    = { d: null, b: null };   // slip verify result per tab
let slipFile    = { d: null, b: null };   // base64 file data per tab

/* ‚îÄ‚îÄ Balance-tab state ‚îÄ‚îÄ */
let __balQrDetected    = null;   // null=‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à, true=‡∏û‡∏ö QR, false=‡πÑ‡∏°‡πà‡∏û‡∏ö QR
let __balSlipPartyData = null;   // { senderName, senderAccount, receiverName, receiverAccount, sendingBank }
let __balRemainingAmt  = 0;      // ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å quote ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
let __balDepositPaid   = 0;      // ‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≤‡∏Å getBalanceInfo)
let __balPack          = '';     // ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à (‡∏à‡∏≤‡∏Å getBalanceInfo)
let __balHead          = '';     // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏±‡∏ß (‡∏à‡∏≤‡∏Å getBalanceInfo)

/* ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ‚îÄ Init (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏£‡∏µ‡πä‡∏î 0.1 ‡∏ß‡∏¥) ‚îÄ‚îÄ‚îÄ */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }

    const profile = await liff.getProfile();
    lineUserId = profile.userId;
    document.getElementById('auth-name').value = profile.displayName;
    setTodayDates();
    setHeaderDate();

    // üåü ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤: ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏à‡∏≥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
    const cacheKey = 'fahpataan_admin_' + lineUserId;
    const cachedAdmin = localStorage.getItem(cacheKey);

    if (cachedAdmin) {
      // üöÄ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏•‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ API)
      adminName = cachedAdmin;
      document.getElementById('hdr-admin').textContent = 'üë§ ' + adminName;
      
      hideLoading();
      showEl('auth', 'none');
      showEl('app', 'block');
      
      // ‡πÅ‡∏≠‡∏ö‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á)
      loadRecent();
      
    } else {
      // üöÄ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏ö‡∏ï‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
      const res = await api({ action: 'getInitData', lineUserId: lineUserId });
      
      if (res && res.isAdmin) {
        adminName = res.adminName;
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        await afterAuth(res);
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å PIN
        hideLoading();
        showEl('auth', 'flex');
      }
    }
  } catch (err) {
    console.error(err);
    if (['localhost','127.0.0.1'].includes(location.hostname)) {
      setTodayDates(); setHeaderDate();
      hideLoading(); showEl('app','block');
    } else {
      toast('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà','err'); hideLoading();
    }
  }
}

async function afterAuth(initialData = null) {
  document.getElementById('hdr-admin').textContent = 'üë§ ' + adminName;
  
  // ‡∏à‡∏≥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î
  localStorage.setItem('fahpataan_admin_' + lineUserId, adminName);

  // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≤‡∏Å getInitData) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
  if (initialData && (initialData.recentDeposits || initialData.recentBalances)) {
    renderRecent('recent-deposit', initialData.recentDeposits || [], false);
    renderRecent('recent-balance', initialData.recentBalances || [], true);
  } else {
    await loadRecent();
  }
  
  hideLoading();
  showEl('auth','none');
  showEl('app','block');
}

/* ‚îÄ‚îÄ‚îÄ Auth PIN ‚îÄ‚îÄ‚îÄ */
async function doVerifyPin() {
  const pin = document.getElementById('auth-pin').value.trim();
  if (!pin) { showAuthErr('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å PIN'); return; }
  setBtnLoad('auth-btn', true);
  try {
    const res = await api({ action: 'registerAdmin', lineUserId, pin });
    if (res.status === 'approved') { adminName = res.name; await afterAuth(); }
    else if (res.status === 'already_linked') showAuthErr('LINE ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß');
    else showAuthErr('PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
  } catch(e) { showAuthErr('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'); }
  setBtnLoad('auth-btn', false, 'üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
}

/* ‚îÄ‚îÄ‚îÄ ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å input[type=date] ‚Üí yyyy-MM-dd (‡∏Ñ.‡∏®. ‡πÄ‡∏™‡∏°‡∏≠) ‚îÄ‚îÄ‚îÄ */
function normDateInput(val) {
  if (!val) return '';
  // input[type=date] ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô "yyyy-MM-dd"
  // ‡πÅ‡∏ï‡πà iOS/Android ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏ä‡πà‡∏ô "2569-02-27"
  const parts = val.split('-');
  if (parts.length === 3) {
    let y = parseInt(parts[0], 10);
    if (y > 2500) y -= 543;          // ‡∏û.‡∏®. ‚Üí ‡∏Ñ.‡∏®.
    return y + '-' + parts[1] + '-' + parts[2];
  }
  return val;
}

/* ‚îÄ‚îÄ‚îÄ Search Quotes by Event Date ‚îÄ‚îÄ‚îÄ */
async function searchQuotes(tab) {
  const p    = tab === 'deposit' ? 'd' : 'b';
  const raw  = document.getElementById(p + '-event-date').value;
  const date = normDateInput(raw);   // ‚Üê ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®.‚Üí‡∏Ñ.‡∏®. ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
  const sel  = document.getElementById(p + '-quote');
  const cnt  = document.getElementById(p + '-result-count');

  if (!date) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô','err'); return; }

  // DEBUG ‚Äî ‡∏î‡∏π‡∏Ñ‡πà‡∏≤ date ‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á GAS
  console.log('[LIFF] raw="' + raw + '"  ‚Üí  date="' + date + '"');
  cnt.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶ [' + date + ']';

  cnt.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶';
  sel.innerHTML = '<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option>';

  try {
    const url = `${GAS_URL}?action=getQuotesByDate&date=${date}&t=${Date.now()}`;
    const res = await (await fetch(url)).json();
    const quotes = res.quotes || [];

    sel.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Quote ‚Äî</option>';
    quotes.forEach(q => sel.add(new Option(q.label, q.quoteNo, false, false)));

    cnt.textContent = quotes.length
      ? `‡∏û‡∏ö ${quotes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏∏‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)`
      : '‚Äî ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ ‚Äî';

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    if (quotes.length === 1) {
      sel.value = quotes[0].quoteNo;
      document.getElementById(p + '-customer').value = quotes[0].customer;
    }
  } catch(e) { cnt.textContent = ''; toast('‚ùå ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','err'); }
}

/* ‚îÄ‚îÄ‚îÄ Quote change ‚Üí auto-fill customer + fetch balance info (b-tab) ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
  ['d','b'].forEach(p => {
    document.getElementById(p + '-quote').addEventListener('change', function() {
      const opt = this.options[this.selectedIndex];
      if (opt && opt.text && opt.text.includes(' ‚Äî ')) {
        const cus = opt.text.split(' ‚Äî ').slice(1).join(' ‚Äî ');
        document.getElementById(p + '-customer').value = cus;
      }
      // b-tab: ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏™‡∏•‡∏¥‡∏õ
      if (p === 'b' && this.value) {
        __balRemainingAmt = 0;
        balSetCompareMsg_('', false);
        google.script.run
          .withSuccessHandler(function(info) {
            if (info) {
              __balRemainingAmt = Number(info.balance)     || 0;
              __balDepositPaid  = Number(info.depositPaid) || 0;
              __balPack         = String(info.pack || '');
              __balHead         = String(info.head || info.headCount || '');
              const el = document.getElementById('b-result-count');
              if (el && __balRemainingAmt > 0) {
                el.textContent = 'üí∞ ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ‡∏ø' + fmt(__balRemainingAmt);
              }
            }
          })
          .withFailureHandler(function() {})
          .getBalanceInfo(this.value);
      } else if (p === 'b') {
        __balRemainingAmt = 0;
        balSetCompareMsg_('', false);
      }
    });
  });
});

/* ‚îÄ‚îÄ‚îÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ QR Code ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢ jsQR ‚îÄ‚îÄ‚îÄ */
function detectQRCode(dataUrl) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = function() {
      try {
        const canvas  = document.createElement('canvas');
        canvas.width  = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        resolve(code ? code.data : null);   // ‡∏Ñ‡∏∑‡∏ô QR string ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠, null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
      } catch(e) { resolve(null); }
    };
    img.onerror = () => resolve(null);
    img.src = dataUrl;
  });
}

/* ‚îÄ‚îÄ‚îÄ Slip Selected ‚Üí ‡∏ï‡∏£‡∏ß‡∏à QR ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á SlipOK ‚îÄ‚îÄ‚îÄ */
function onSlipSelected(p) {
  const file = document.getElementById('slip-file-' + p).files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = e.target.result.split(',')[1];
    slipFile[p] = { data: base64, mimeType: file.type, name: file.name };

    // Preview
    const preview = document.getElementById('slip-preview-' + p);
    preview.src = e.target.result;
    preview.style.display = 'block';
    document.getElementById('slip-placeholder-' + p).style.display = 'none';
    document.getElementById('slip-zone-' + p).classList.add('has-img');

    slipData[p] = null;
    document.getElementById(p + '-verify-btn').disabled = true;
    showVerifyBox(p, 'skip', 'üîç', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ QR code‚Ä¶');

    // ‚îÄ‚îÄ Step 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ QR code ‡∏ù‡∏±‡πà‡∏á browser ‚îÄ‚îÄ
    const qrData = await detectQRCode(e.target.result);

    if (qrData) {
      // ‡∏°‡∏µ QR ‚Üí ‡∏™‡πà‡∏á SlipOK ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      showVerifyBox(p, 'skip', '‚è≥', '‡∏û‡∏ö QR code ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à SlipOK‚Ä¶');
      doVerifySlip(p);
    } else {
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ QR ‚Üí ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
      showVerifyBox(p, 'skip', 'üìù', '‡πÑ‡∏°‡πà‡∏û‡∏ö QR code ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á');
      document.getElementById(p + '-verify-btn').disabled = false;  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠
    }
  };
  reader.readAsDataURL(file);
}

/* ‚îÄ‚îÄ‚îÄ Verify Slip ‚îÄ‚îÄ‚îÄ */
async function doVerifySlip(p) {
  if (!slipFile[p]) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô','err'); return; }

  const btn = document.getElementById(p + '-verify-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0 auto"></div>';

  try {
    const res = await api({ action: 'verifySlip', file: slipFile[p] });

    if (res.status !== 'ok' || !res.result) {
      toast('‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res.message || ''), 'err');
      showVerifyBox(p, 'fail', '‚ùå', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      const r = res.result;
      slipData[p] = r;

      if (r.verified) {
        showVerifyBox(p, 'ok', '‚úÖ', `VERIFIED ‚Äî ‡∏ø${fmt(r.depositAmount)} (${r.sendingBank || '?'} ‚Üí ‡∏£‡∏±‡∏ö)`);
        // Auto-fill amount & date
        if (r.depositAmount > 0)  document.getElementById(p + '-amount').value = r.depositAmount;
        if (r.depositDate)         document.getElementById(p + '-date').value   = r.depositDate;
        toast('‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'ok');

      } else if (r.verifyStatus === 'DELAY') {
        showVerifyBox(p, 'delay', '‚è≥', `DELAY (‡∏£‡∏≠ ${r.delayMin || '?'} ‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî ` + r.verifyMessage);
        if (r.depositAmount > 0) document.getElementById(p + '-amount').value = r.depositAmount;
        if (r.depositDate)        document.getElementById(p + '-date').value   = r.depositDate;
        toast('‚è≥ ‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (DELAY)', '');

      } else {
        showVerifyBox(p, 'fail', '‚ùå', `FAILED [${r.verifyCode}] ‚Äî ` + r.verifyMessage);
        toast('‚ö†Ô∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ' + r.verifyMessage, 'err');
      }
    }
  } catch(e) { toast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'err'); }

  btn.disabled = false;
  btn.innerHTML = '<span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
}

function showVerifyBox(p, type, ico, msg) {
  const box  = document.getElementById(p + '-verify-box');
  const icoEl = document.getElementById(p + '-v-ico');
  const msgEl = document.getElementById(p + '-v-msg');
  box.className = 'verify-box ' + type;
  icoEl.textContent = ico;
  msgEl.textContent = msg;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BAL* HELPERS ‚Äî flow ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tab ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (b) ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* 1. Reset slip panel (b-tab) */
function balResetSlipPanel_() {
  slipData['b'] = null;
  slipFile['b'] = null;
  __balQrDetected    = null;
  __balSlipPartyData = null;
  const prev = document.getElementById('slip-preview-b');
  const ph   = document.getElementById('slip-placeholder-b');
  prev.style.display = 'none';
  ph.style.display   = 'block';
  document.getElementById('slip-zone-b').classList.remove('has-img');
  document.getElementById('slip-file-b').value = '';
  document.getElementById('b-verify-btn').disabled = true;
  document.getElementById('b-verify-box').className = 'verify-box';
}

/* 2a. Lock amount + date (‡∏´‡∏•‡∏±‡∏á SlipOK ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ) */
function balLockAmountDate_() {
  const amt  = document.getElementById('b-amount');
  const date = document.getElementById('b-date');
  if (amt)  { amt.readOnly  = true; }
  if (date) { date.readOnly = true; }
}

/* 2b. Unlock amount + date (‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á) */
function balUnlockAmountDate_() {
  const amt  = document.getElementById('b-amount');
  const date = document.getElementById('b-date');
  if (amt)  { amt.readOnly  = false; }
  if (date) { date.readOnly = false; }
}

/* 3a. ‡∏ï‡∏±‡πâ‡∏á/‡∏ã‡πà‡∏≠‡∏ô compare message */
function balSetCompareMsg_(msg, show) {
  const el = document.getElementById('b-compare-msg');
  if (!el) return;
  if (!show || !msg) { el.className = 'compare-msg'; el.textContent = ''; return; }
  el.textContent = msg;
  // ‡∏ï‡∏±‡πâ‡∏á class ‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
  if (msg.startsWith('‚úÖ')) el.className = 'compare-msg ok';
  else if (msg.includes('‡πÄ‡∏Å‡∏¥‡∏ô')) el.className = 'compare-msg over';
  else el.className = 'compare-msg under';
}

/* 3b. ‡∏ï‡∏±‡πâ‡∏á upload/processing msg ‡∏ú‡πà‡∏≤‡∏ô verify-box */
function balSetUploadMsg_(type, ico, msg) {
  showVerifyBox('b', type, ico, msg);
}

/* 4. Toggle bank group ‡∏ï‡∏≤‡∏° radio ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
function balToggleBankGroup_() {
  const radios = document.querySelectorAll('input[name="b-pay"]');
  let selected = '‡πÇ‡∏≠‡∏ô';
  radios.forEach(r => {
    const lbl = document.getElementById('b-pay-label-' +
      (r.value === '‡πÇ‡∏≠‡∏ô' ? 'transfer' : r.value === '‡πÄ‡∏ä‡πá‡∏Ñ' ? 'cheque' : 'cash'));
    if (lbl) lbl.classList.toggle('selected', r.checked);
    if (r.checked) selected = r.value;
  });
  const bankGrp = document.getElementById('b-bank-group');
  if (bankGrp) bankGrp.style.display = (selected === '‡πÇ‡∏≠‡∏ô' || selected === '‡πÄ‡∏ä‡πá‡∏Ñ') ? '' : 'none';
}

/* 5. ‡∏ï‡∏£‡∏ß‡∏à QR ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢ jsQR (‡∏Ñ‡∏∑‡∏ô null = ‡πÑ‡∏°‡πà‡∏û‡∏ö, string = ‡∏û‡∏ö) */
function balDetectQrInImage_(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = async e => {
      try {
        const qr = await detectQRCode(e.target.result);
        resolve(qr);
      } catch(err) { resolve(null); }
    };
    reader.onerror = () => resolve(null);
    reader.readAsDataURL(file);
  });
}

/* 6. ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô base64 object */
function balFileToBase64_(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const b64 = e.target.result.split(',')[1];
      resolve({ data: b64, mimeType: file.type, name: file.name });
    };
    reader.onerror = () => reject(new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'));
    reader.readAsDataURL(file);
  });
}

/* 8a. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á UI ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï) */
function balFillSlipPartyFields_(res) {
  if (!res) return;
  const d = res.slipData || res.data || {};
  __balSlipPartyData = {
    senderName:     String((d.sender    && (d.sender.displayName    || d.sender.name))    || res.senderName    || '').trim(),
    senderAccount:  String((d.sender    && d.sender.account && (d.sender.account.value    || d.sender.accountValue)) || res.senderAccount  || '').trim(),
    receiverName:   String((d.receiver  && (d.receiver.displayName  || d.receiver.name))  || res.receiverName  || '').trim(),
    receiverAccount:String((d.receiver  && d.receiver.account && (d.receiver.account.value|| d.receiver.accountValue))|| res.receiverAccount|| '').trim(),
    sendingBank:    String(d.sendingBank || res.sendingBank || '').trim()
  };
}

/* 8d. Auto-select "‡πÇ‡∏≠‡∏ô" + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ */
function balAutoSelectTransferAndBank_(res) {
  // ‡∏ï‡∏¥‡πä‡∏Å "‡πÇ‡∏≠‡∏ô"
  const radioTransfer = document.getElementById('b-pay-transfer');
  if (radioTransfer) { radioTransfer.checked = true; balToggleBankGroup_(); }

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  const bankSel = document.getElementById('b-bank');
  if (!bankSel || !res) return;
  const d = res.slipData || res.data || {};
  const bankRaw = String(d.sendingBank || res.sendingBank || '').trim();
  if (!bankRaw) return;

  // ‡∏´‡∏≤ option ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°" ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏à‡∏≤‡∏Å SlipOK
  const BANK_MAP = {
    '‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢':'‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢','kbank':'‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢',
    '‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå':'‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå','scb':'‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå',
    '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û':'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û','bbl':'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û',
    '‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢':'‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢','ktb':'‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢',
    '‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤':'‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤','bay':'‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤','‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ':'‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',
    '‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï':'‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï','ttb':'‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï','‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢':'‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï','‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï':'‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï',
    '‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô':'‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô','gsb':'‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô',
    '‡∏ò.‡∏Å.‡∏™.':'‡∏ò.‡∏Å.‡∏™.','baac':'‡∏ò.‡∏Å.‡∏™.',
    '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå':'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå','promptpay':'‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå'
  };
  const key = bankRaw.toLowerCase().replace(/\s/g,'');
  let mapped = '';
  for (const k in BANK_MAP) {
    if (key.includes(k)) { mapped = BANK_MAP[k]; break; }
  }
  if (mapped) {
    const opts = Array.from(bankSel.options);
    const found = opts.find(o => o.value === mapped);
    if (found) bankSel.value = found.value;
  }
}

/* 8e. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
function balCompareSlipAmountToRemaining_(slipAmt) {
  const remaining = __balRemainingAmt;
  if (!slipAmt || slipAmt <= 0) { balSetCompareMsg_('', false); return; }
  if (!remaining || remaining <= 0) { balSetCompareMsg_('', false); return; }
  const diff = slipAmt - remaining;
  let msg;
  if (Math.abs(diff) < 1) {
    msg = `‚úÖ ‡∏¢‡∏≠‡∏î‡∏™‡∏•‡∏¥‡∏õ ‡∏ø${fmt(slipAmt)} ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ø${fmt(remaining)} ‡∏û‡∏≠‡∏î‡∏µ`;
  } else if (diff > 0) {
    msg = `‚ö†Ô∏è ‡∏¢‡∏≠‡∏î‡∏™‡∏•‡∏¥‡∏õ ‡∏ø${fmt(slipAmt)} ‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ø${fmt(remaining)} (‡πÄ‡∏Å‡∏¥‡∏ô ‡∏ø${fmt(diff)})`;
  } else {
    msg = `‚ö†Ô∏è ‡∏¢‡∏≠‡∏î‡∏™‡∏•‡∏¥‡∏õ ‡∏ø${fmt(slipAmt)} ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ø${fmt(remaining)} (‡∏Ç‡∏≤‡∏î ‡∏ø${fmt(Math.abs(diff))})`;
  }
  balSetCompareMsg_(msg, true);
}

/* ‚îÄ‚îÄ Callback: ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏à‡∏≤‡∏Å verifySlipOnly ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‚îÄ‚îÄ */
function balOnSlipOkResult_(res) {
  document.getElementById('b-verify-btn').disabled = false;

  if (!res) {
    balSetUploadMsg_('fail', '‚ùå', '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏à‡∏≤‡∏Å SlipOK');
    return;
  }

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô submit
  slipData['b'] = res;

  // 8a. ‡πÄ‡∏ï‡∏¥‡∏°‡∏¢‡∏≠‡∏î/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  const amount = Number(res.depositAmount || 0);
  const date   = res.depositDate || '';
  if (amount > 0) document.getElementById('b-amount').value = amount;
  if (date)       document.getElementById('b-date').value   = date;

  // 8b. Lock ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡πà‡∏≤
  if (amount > 0 || date) balLockAmountDate_();

  // 8c. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• party ‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡∏ä‡∏µ‡∏ï (‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå UI)
  balFillSlipPartyFields_(res);

  // 8d. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ
  const status = res.verifyStatus || '';
  if (res.verified || status === 'VERIFIED') {
    const bank = (res.slipData && res.slipData.sendingBank) || res.sendingBank || '?';
    balSetUploadMsg_('ok', '‚úÖ', `VERIFIED ‚Äî ‡∏ø${fmt(amount)} (${bank} ‚Üí ‡∏£‡∏±‡∏ö)`);
    toast('‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'ok');
  } else if (res.verifyCode === '1012') {
    // ‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ ‚Äî ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏¢‡∏≠‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ
    if (amount > 0) {
      balSetUploadMsg_('delay', '‚ö†Ô∏è', `‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ [1012] ‡∏ø${fmt(amount)} ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥`);
      toast('‚ö†Ô∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥', '');
    } else {
      balUnlockAmountDate_();
      balSetUploadMsg_('delay', '‚ö†Ô∏è', `‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ [1012] ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥`);
      toast('‚ö†Ô∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏ã‡πâ‡∏≥ ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á', '');
    }
  } else if (status === 'DELAY') {
    balSetUploadMsg_('delay', '‚è≥', `DELAY (‡∏£‡∏≠ ${res.delayMin || '?'} ‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî ${res.verifyMessage || ''}`);
    toast('‚è≥ ‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (DELAY)', '');
  } else if (status === 'SKIPPED') {
    balSetUploadMsg_('skip', 'üìù', `‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏£‡∏ß‡∏à SlipOK ‚Äî ${res.verifyMessage || res.verifyCode || ''}`);
  } else {
    balSetUploadMsg_('fail', '‚ùå', `FAILED [${res.verifyCode || '?'}] ‚Äî ${res.verifyMessage || ''}`);
    toast('‚ö†Ô∏è ‡∏™‡∏•‡∏¥‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ' + (res.verifyMessage || ''), 'err');
  }

  // 8e. Auto-select ‡πÇ‡∏≠‡∏ô + ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  balAutoSelectTransferAndBank_(res);

  // 8f. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  balCompareSlipAmountToRemaining_(amount);
}

/* ‚îÄ‚îÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (b-verify-btn) ‚îÄ‚îÄ */
function balReVerifySlip_() {
  if (!slipFile['b']) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô','err'); return; }
  const btn = document.getElementById('b-verify-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0 auto"></div>';
  balSetUploadMsg_('skip', '‚è≥', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à SlipOK ‡πÉ‡∏´‡∏°‡πà‚Ä¶');
  google.script.run
    .withSuccessHandler(function(res) {
      btn.innerHTML = '<span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
      balOnSlipOkResult_(res);
    })
    .withFailureHandler(function(err) {
      btn.disabled = false;
      btn.innerHTML = '<span>üîÑ</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
      balSetUploadMsg_('fail', '‚ùå', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err && err.message ? err.message : String(err)));
    })
    .verifySlipOnly({ file: slipFile['b'] });
}

/* ‚ïê‚ïê‚ïê‚ïê MAIN: New Balance slip-selected flow ‚ïê‚ïê‚ïê‚ïê */
async function onBalSlipSelected_() {
  const file = document.getElementById('slip-file-b').files[0];
  if (!file) return;

  /* ‚ë† Reset slip panel */
  balResetSlipPanel_();

  /* ‚ë° Unlock amount/date ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á */
  balUnlockAmountDate_();

  /* ‚ë¢ Reset compare msg + ‡πÅ‡∏™‡∏î‡∏á "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•" */
  balSetCompareMsg_('', false);
  balSetUploadMsg_('skip', '‚è≥', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‚Ä¶');

  // ‡πÅ‡∏™‡∏î‡∏á preview ‡∏Å‡πà‡∏≠‡∏ô
  const previewDataUrl = await new Promise(resolve => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = () => resolve(null);
    r.readAsDataURL(file);
  });
  if (previewDataUrl) {
    const prev = document.getElementById('slip-preview-b');
    prev.src = previewDataUrl;
    prev.style.display = 'block';
    document.getElementById('slip-placeholder-b').style.display = 'none';
    document.getElementById('slip-zone-b').classList.add('has-img');
  }

  /* ‚ë£ ‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå */
  const mime = (file.type || '').toLowerCase();
  const isImage = mime === 'image/png' || mime === 'image/jpeg' || mime === 'image/jpg';
  if (!isImage) {
  __balQrDetected = false;
  // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô"
  try {
    const fileObj0 = await balFileToBase64_(file);
    slipFile['b'] = fileObj0;
  } catch(e) { /* ‡πÑ‡∏°‡πà critical */ }
  balSetUploadMsg_('skip', 'üìÑ', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ PNG/JPG ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á');
  document.getElementById('b-verify-btn').disabled = false;
  return;
}

  /* ‚ë§ ‡∏ï‡∏£‡∏ß‡∏à QR ‡πÉ‡∏ô‡∏£‡∏π‡∏õ */
  balSetUploadMsg_('skip', 'üîç', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ QR code‚Ä¶');
  let qrData = null;
  let qrError = false;
  try {
    qrData = await balDetectQrInImage_(file);
  } catch(e) {
    qrError = true; // ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‚Üí ‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πà‡∏≠
  }

  if (!qrError && qrData === null) {
    // ‡πÑ‡∏°‡πà‡∏û‡∏ö QR ‚Üí ‡∏Ç‡πâ‡∏≤‡∏° SlipOK ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Re-verify / Submit
    __balQrDetected = false;
    try {
      const fileObj0 = await balFileToBase64_(file);
      slipFile['b'] = fileObj0;
    } catch(e) { /* ‡πÑ‡∏°‡πà critical */ }
    balSetUploadMsg_('skip', 'üìù', '‡πÑ‡∏°‡πà‡∏û‡∏ö QR code ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á');
    document.getElementById('b-verify-btn').disabled = false;
    return;
  }

  // ‡∏û‡∏ö QR ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‚Üí ‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à SlipOK
  __balQrDetected = (qrData !== null);
  balSetUploadMsg_('skip', '‚è≥', '‡∏û‡∏ö QR code ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à SlipOK‚Ä¶');

  /* ‚ë• ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 */
  let fileObj;
  try {
    fileObj = await balFileToBase64_(file);
  } catch(e) {
    balSetUploadMsg_('fail', '‚ùå', '‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message);
    return;
  }
  slipFile['b'] = fileObj;

  /* ‚ë¶ ‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à SlipOK ‡∏ó‡∏µ‡πà GAS ‡∏ú‡πà‡∏≤‡∏ô google.script.run */
  balSetUploadMsg_('skip', '‚è≥', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏±‡∏ö SlipOK‚Ä¶');
  google.script.run
    .withSuccessHandler(function(res) {
      balOnSlipOkResult_(res);
    })
    .withFailureHandler(function(err) {
      balSetUploadMsg_('fail', '‚ùå', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err && err.message ? err.message : String(err)));
      document.getElementById('b-verify-btn').disabled = false;
    })
    .verifySlipOnly({ file: fileObj });
}

/* ‚îÄ‚îÄ‚îÄ Submit Deposit ‚îÄ‚îÄ‚îÄ */
async function doSubmitDeposit() {
  const quoteNo  = v('d-quote');
  const customer = v('d-customer');
  const amount   = v('d-amount');
  const date     = v('d-date');
  const note     = v('d-note');

  if (!quoteNo || !amount || !date) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','err'); return; }
  if (+amount <= 0) { toast('‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0','err'); return; }

  setBtnLoad('d-btn', true);
  try {
    const slip = buildSlipPayload('d');
    const file = slipFile['d']; // üåü 1. ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ

    // üåü 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ file ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ
    const res  = await api({ action:'saveDeposit', lineUserId, adminName,
                              quoteNo, customer, amount:+amount, date, note, slip, file });
                              
    if (res.status === 'success') {
      toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥ + ‡πÅ‡∏à‡πâ‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß', 'ok');
      resetForm('d');
      await loadRecent();
    } else { toast('‚ùå ' + (res.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'), 'err'); }
  } catch(e) { toast('‚ùå ' + e.message, 'err'); }
  setBtnLoad('d-btn', false, '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE');
}

/* ‚îÄ‚îÄ‚îÄ Submit Balance ‚îÄ‚îÄ‚îÄ */
function doSubmitBalance() {
  // 1) ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
  var quoteNo = (document.getElementById('b-quote') ? document.getElementById('b-quote').value : '').trim();
  if (!quoteNo) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', 'err'); return; }

  var amountRaw = document.getElementById('b-amount') ? document.getElementById('b-amount').value : '0';
  var received = parseFloat(String(amountRaw).replace(/,/g, ''));
  if (!received || received <= 0) { toast('‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'err'); return; }

  var receiveDate = document.getElementById('b-date') ? document.getElementById('b-date').value : '';
  if (!receiveDate) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'err'); return; }

  var customer = document.getElementById('b-customer') ? document.getElementById('b-customer').value : '';
  var note = document.getElementById('b-note') ? document.getElementById('b-note').value : '';

  // 2) ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ + ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏à‡∏≤‡∏Å UI ‡πÉ‡∏´‡∏°‡πà)
  var paymentMethod = '‡πÇ‡∏≠‡∏ô';
  var radios = document.querySelectorAll('input[name=‚Äùb-pay‚Äù]');
  radios.forEach(function(r) { if (r.checked) paymentMethod = r.value; });
  var bankName = (document.getElementById('b-bank') ? document.getElementById('b-bank').value : '') || '';

  // 3) ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ SlipOK
  var r = slipData['b'] || {};
  var d = r.slipData || {};

  // 4) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• party ‡∏à‡∏≤‡∏Å __balSlipPartyData (‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏î‡∏¢ balFillSlipPartyFields_)
  var party = __balSlipPartyData || {};

  // slipFile['b'] ‡πÄ‡∏õ‡πá‡∏ô base64 object: { data, mimeType, name }
  var fileObj = slipFile['b'] || null;

  // 5) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Payload (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô submitBalanceReceipt ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å)
  var formData = {
    quoteNo:      quoteNo,
    customerName: customer,
    pack: __balPack || '', head: __balHead || '',
    depositPaid: __balDepositPaid  || 0,
    balanceBefore: __balRemainingAmt || 0,

    receivedAmount: received,
    receiveDate:    receiveDate,
    paymentMethod:  paymentMethod,
    bankName:       bankName || party.sendingBank || d.sendingBank || '',
    chequeNo:       '',
    note:           note,

    // SlipOK result
    qrDetected:    (__balQrDetected === null) ? (!!r.qrcodeData) : __balQrDetected,
    slipOkVerified:(r.verifyStatus === 'VERIFIED') || (r.verified === true),
    slipOkStatus:  r.verifyStatus  || '',
    slipOkCode:    r.verifyCode    || '',
    slipOkMessage: r.verifyMessage || '',
    slipAmount:    d.amount  || r.depositAmount || '',
    slipDate:      d.transDate || r.depositDate || '',

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÇ‡∏≠‡∏ô/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏à‡∏≤‡∏Å __balSlipPartyData)
    senderName:     party.senderName     || (d.sender   && (d.sender.displayName   || d.sender.name))   || '',
    senderAccount:  party.senderAccount  || (d.sender   && d.sender.account && (d.sender.account.value   || d.sender.accountValue))   || '',
    receiverName:   party.receiverName   || (d.receiver && (d.receiver.displayName || d.receiver.name))  || '',
    receiverAccount:party.receiverAccount|| (d.receiver && d.receiver.account && (d.receiver.account.value|| d.receiver.accountValue)) || '',

    adminName:  (typeof adminName  !== 'undefined' ? adminName  : ''),
    lineUserId: (typeof lineUserId !== 'undefined' ? lineUserId : '')
  };

  // 6) ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô
  if (fileObj && fileObj.data) {
    var mime = fileObj.mimeType || 'image/jpeg';
    formData.proofFileBase64 = 'data:' + mime + ';base64,' + fileObj.data;
    formData.proofFileName   = fileObj.name || 'BalanceSlip';
  }

  // 7) UI Loading
  setBtnLoad('b-btn', true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');

  // 8) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
  google.script.run
    .withSuccessHandler(function(res) {
      setBtnLoad('b-btn', false, '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE');
      if (res && res.warning && res.warningMessage) { alert(res.warningMessage); }
      toast('‚úÖ ' + (res && res.message ? res.message : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'), 'ok');
      resetForm('b');
      if (typeof loadRecent === 'function') loadRecent();
    })
    .withFailureHandler(function(err) {
      setBtnLoad('b-btn', false, '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏™‡πà‡∏á LINE');
      var msg = (err && err.message) ? err.message : String(err || '');
      toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + msg, 'err');
    })
    .saveBalanceReceipt(formData);
}
  
/* ‚îÄ‚îÄ‚îÄ Load Recent ‚îÄ‚îÄ‚îÄ */
async function loadRecent() {
  try {
    const res = await api({ action:'getRecent', limit:5 });
    renderRecent('recent-deposit', res.deposits||[], false);
    renderRecent('recent-balance', res.balances||[], true);
  } catch(e) {}
}

function renderRecent(id, items, isBlue) {
  const el = document.getElementById(id);
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="ico">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>';
    return;
  }
  const color = isBlue ? 'var(--blue)' : 'var(--green)';
  el.innerHTML = items.map(r => {
    const amtStr  = '‡∏ø' + fmt(r.amount);
    const evLabel = r.eventDate ? 'üìÖ ' + r.eventDate : (r.date || '');
    const admin   = r.by ? '¬∑ ' + r.by : '';
    return `
    <div class="recent-row">
      <div style="flex:1;min-width:0">
        <div class="rr-name" style="display:flex;align-items:baseline;gap:6px;flex-wrap:wrap">
          <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
            ${r.quoteNo||'‚Äî'} ‚Äî ${r.customer||'‚Äî'}
          </span>
          <span style="color:${color};font-weight:700;font-size:15px;white-space:nowrap">${amtStr}</span>
        </div>
        <div class="rr-meta">${evLabel} ${admin}</div>
      </div>
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ */
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('nav-'+page).classList.add('active');
  window.scrollTo(0,0);
}

/* ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ */
async function api(payload) {
  const res = await fetch(GAS_URL, {
    method:'POST', headers:{'Content-Type':'text/plain'},
    body: JSON.stringify(payload)
  });
  return res.json();
}

/* ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ */
function v(id) { return document.getElementById(id).value.trim(); }

function setTodayDates() {
  const t = new Date().toISOString().split('T')[0];
  ['d-date','b-date'].forEach(id => { const el=document.getElementById(id); if(el) el.value=t; });
}
function setHeaderDate() {
  const el = document.getElementById('hdr-date');
  if (el) el.textContent = new Date().toLocaleDateString('th-TH',
    { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}
function hideLoading() {
  const el = document.getElementById('loading');
  el.style.opacity = '0';
  setTimeout(() => el.style.display='none', 420);
}
function showEl(id, display) { document.getElementById(id).style.display = display; }
function showAuthErr(msg) {
  const el = document.getElementById('auth-err');
  el.textContent = msg; el.style.display = 'block';
}
function resetForm(p) {
  ['quote','customer','amount','note'].forEach(f => {
    const el = document.getElementById(p+'-'+f);
    if (!el) return;
    el.tagName==='SELECT' ? (el.selectedIndex=0) : (el.value='');
  });
  setTodayDates();
  // reset slip
  slipData[p] = null; slipFile[p] = null;
  document.getElementById('slip-preview-'+p).style.display = 'none';
  document.getElementById('slip-placeholder-'+p).style.display = 'block';
  document.getElementById('slip-zone-'+p).classList.remove('has-img');
  document.getElementById('slip-file-'+p).value = '';
  document.getElementById(p+'-verify-btn').disabled = true;
  document.getElementById(p+'-verify-box').className = 'verify-box';
  document.getElementById(p+'-result-count').textContent = '';

  // balance-tab: reset extra state + UI
  if (p === 'b') {
    __balQrDetected    = null;
    __balSlipPartyData = null;
    __balRemainingAmt  = 0;
    __balDepositPaid   = 0;
    __balPack          = '';
    __balHead          = '';
    // unlock amount/date
    balUnlockAmountDate_();
    // reset compare msg
    balSetCompareMsg_('', false);
    // reset payment method ‚Üí ‡πÇ‡∏≠‡∏ô (default)
    const radioTransfer = document.getElementById('b-pay-transfer');
    if (radioTransfer) { radioTransfer.checked = true; balToggleBankGroup_(); }
    // reset bank
    const bankSel = document.getElementById('b-bank');
    if (bankSel) bankSel.value = '';
  }
}
function setBtnLoad(id, loading, label) {
  const btn = document.getElementById(id);
  btn.disabled = loading;
  if (loading) btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div>';
  else if (label) btn.innerHTML = label;
}
function fmt(n) { return Number(n||0).toLocaleString('th-TH',{minimumFractionDigits:2}); }
let _tt;
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast '+(type||'');
  void el.offsetWidth; el.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(()=>el.classList.remove('show'), 3200);
}

init();
</script>
</body>
</html>
